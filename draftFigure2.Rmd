---
title: "Figure two"
author: "Ella Henninger"
date: "2025-10-17"
output: html_document
---

Redo figure 2 with the 'share of papers mentioning a topic' instead, so the percentages would go above 100% which is ok. Also for the other panels, calculate the percentages per subgroups that mention,
which will also make each 'column' going above 100%


```{r setup, include=FALSE}

## clean environment
rm(list = ls())

# Define which packages needed for analyses
p_needed <-
  c("knitr",
    "dplyr", 
    "stargazer",
    "ggplot2",
    "viridis",
    "haven",
    "MASS",
    "modelsummary",
    "tidyr",
    "data.table",
    "scales",
    "tidyverse",
    "treemapify",
    "ggnewscale")

# Check which packages are already installed on your computer
packages <- rownames(installed.packages())

# Check which packages are not installed
p_to_install <- p_needed[!(p_needed %in% packages)]

if (length(p_to_install) > 0) {
  install.packages(p_to_install)
}
sapply(p_needed, require, character.only = TRUE)


# Set an option for the final document that can be produced from the .Rmd file.
knitr::opts_chunk$set(echo = TRUE)

## For replicability: session information 
session_info <- print(sessionInfo())
```

## Load the data

```{r data}

#-------------------------------------------------------------------------------
# Load the data
#-------------------------------------------------------------------------------
papers <- read.csv2("output/paperClassifYear.csv", 
                    header = T, sep = ",", dec = ".")

surveys <- read.csv2("output/surveyClassifYear.csv", 
                     header = T, sep = ",", dec = ".")

dataSummary <- read.csv("output/datasetPlots.csv")

papers <- papers %>% 
  filter(!is.na(iso3))

surveys <- surveys %>% 
  filter(!is.na(iso3))

dataSummary <- dataSummary %>% 
  filter(!is.na(iso3))

dataSummary$categoryPollution <- ifelse(
  !is.na(dataSummary$categoryPollution),
  paste0(toupper(substr(dataSummary$categoryPollution, 1, 1)),
         substr(dataSummary$categoryPollution, 2, nchar(dataSummary$categoryPollution))),
  NA
)

dataSummary$categoryPollution <- factor(
  dataSummary$categoryPollution,
  levels = rev(c(
    "Very high",
    "High",
    "Medium",
    "Low",
    "Very low"
  )),
  ordered = TRUE
)

papers <- merge(papers, dataSummary, by = "iso3", all.x = T, all.y = F)
surveys <- merge(surveys, dataSummary, by = "iso3", all.x = T, all.y = F)

```

## Filter (only Inclusion = 1 items)

```{r clean}

#-------------------------------------------------------------------------------
# Inclusion = 1 for survey items 
#-------------------------------------------------------------------------------

## surveys: drop items for which Inclusion == 0
surveys <- surveys[which(surveys$Inclusion == 1),]

## subset survey without Flashbarometer
surveys_sub <- surveys[which(surveys$source != "Flash Eurobarometer 360: Attitudes of Europeans towards air quality"),]

```

## Visualizations full data

```{r visualise}

#-------------------------------------------------------------------------------
# papers
#-------------------------------------------------------------------------------

# count category
papers_long <- papers %>%
  count(category, name = "n") %>%   # counts per category
  mutate(share = n / sum(n)) %>%    # sum(n) is the grand total here
  rename(Topic = category)

# bar plot with counts and percentage labels
pdf("plots/Figure2_category_paper_barplot.pdf")
ggplot(papers_long, aes(x = reorder(Topic, -n), y = n, fill = Topic)) +
  geom_col(color = "black") +
  geom_text(aes(label = percent(share, accuracy = 1)),
            vjust = -0.3, size = 5) +
  labs(x = NULL, y = "Number of papers") +
  scale_fill_manual(values = c(
    "Perceptions" = "#8B7B8B",
    "Behavior"    = "#EED8AE",
    "Priority"    = "#CDB5CD",
    "Policy"      = "#CD919E",
    "Health"      = "#8B475D",
    "None"        = "#F4A460")) +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 30, hjust = 1, size = 15),
    axis.text.y = element_text(size = 15),
    axis.title = element_text(size = 16)
    )
dev.off()


## Different visualisation

pdf("plots/Figure2_category_paper_tiles.pdf")
ggplot(papers_long, aes(area = share, fill = Topic, label = paste0(Topic, "\n", scales::percent(share, accuracy = 1)))) +
  geom_treemap(color = "white", size = 10) +
  geom_treemap_text(colour = "white", place = "centre", grow = F, reflow = TRUE) +
  scale_fill_manual(values = c(
  "Perceptions" = "#8B7B8B",
  "Behavior"    = "#EED8AE",
  "Priority"    = "#CDB5CD",
  "Policy"      = "#CD919E",
  "Health"      = "#8B475D",
  "None"        = "#F4A460")) +
  theme(legend.position = "none")
dev.off()



#-------------------------------------------------------------------------------
# surveys
#-------------------------------------------------------------------------------
surveys_long <- surveys %>%
  count(category, name = "n") %>%   # counts per category
  mutate(share = n / sum(n)) %>%    # sum(n) is the grand total here
  rename(Topic = category)

# bar plot with counts and percentage labels
pdf("plots/Figure2_category_survey_barplot.pdf")
ggplot(surveys_long, aes(x = reorder(Topic, -n), y = n, fill = Topic)) +
  geom_col(color = "black") +
  geom_text(aes(label = percent(share, accuracy = 1)),
            vjust = -0.3, size = 5) +
  labs(x = NULL, y = "Number of items") +
  scale_fill_manual(values = c(
    "Perceptions" = "#8B7B8B",
    "Behavior"    = "#EED8AE",
    "Priority"    = "#CDB5CD",
    "Policy"      = "#CD919E",
    "Health"      = "#8B475D",
    "None"        = "#F4A460")) +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 30, hjust = 1, size = 15),
    axis.text.y = element_text(size = 15),
    axis.title = element_text(size = 16))
dev.off()

## Different approach
pdf("plots/Figure2_category_survey_tiles.pdf")
ggplot(surveys_long, aes(area = share, fill = Topic, label = paste0(Topic, "\n", scales::percent(share, accuracy = 1)))) +
  geom_treemap(color = "white", size = 10) +
  geom_treemap_text(colour = "white", place = "centre", grow = F, reflow = TRUE) +
  scale_fill_manual(values = c(
  "Perceptions" = "#8B7B8B",
  "Behavior"    = "#EED8AE",
  "Priority"    = "#CDB5CD",
  "Policy"      = "#CD919E",
  "Health"      = "#8B475D",
  "None"        = "#F4A460")) +
  theme(legend.position = "none")
dev.off()

```

## Visualization counting the share of papers & survey items instead of the raw count for each category


```{r}

#-------------------------------------------------------------------------------
# papers
#-------------------------------------------------------------------------------

papers_long <- papers %>%
  group_by(category) %>%
  summarise(n = n_distinct(ID)) %>%
  rename(Topic = category) %>% 
  mutate(share = n / length(unique(papers$ID)))

# bar plot with counts and percentage labels
pdf("plots/Figure2_category_paper_barplot_share.pdf", width = 12, height = 10)
ggplot(papers_long, aes(y = reorder(Topic, n), x = n, fill = Topic)) +
  geom_col(color = "black") +
  geom_text(aes(label = percent(share, accuracy = 1)),
            hjust = -0.3, size = 9) +
  labs(y = NULL, x = "Number of papers covering each category") +
  scale_fill_manual(values = c(
    "Perceptions" = "#8B7B8B",
    "Behavior"    = "#EED8AE",
    "Priority"    = "#CDB5CD",
    "Policy"      = "#CD919E",
    "Health"      = "#8B475D",
    "None"        = "#F4A460")) +
  theme_minimal() +
  xlim(0, 450) +
  theme(
    legend.position = "none",
    axis.text.y = element_text(size = 22),
    axis.text.x = element_text(size = 22),
    axis.title = element_text(size = 23)
    )
dev.off()

#-------------------------------------------------------------------------------
# surveys
#-------------------------------------------------------------------------------

surveys_long <- surveys %>%
  mutate(item_id = paste0(iso3, id, year)) %>% 
  distinct(item_id, category) %>%     # collapse multiple rows for same IDâ€“category pair
  count(category, name = "n") %>% 
  mutate(share = n / length(unique(paste0(surveys$iso3, surveys$id)))) %>%
  rename(Topic = category)

# bar plot with counts and percentage labels
pdf("plots/Figure2_category_survey_barplot_share.pdf", width = 12, height = 10)
ggplot(surveys_long, aes(y = reorder(Topic, n), x = n, fill = Topic)) +
  geom_col(color = "black") +
  geom_text(aes(label = percent(share, accuracy = 1)),
            hjust = -0.3, size = 9) +
  labs(y = NULL, x = "Number of survey items covering each category") +
  scale_fill_manual(values = c(
    "Perceptions" = "#8B7B8B",
    "Behavior"    = "#EED8AE",
    "Priority"    = "#CDB5CD",
    "Policy"      = "#CD919E",
    "Health"      = "#8B475D",
    "None"        = "#F4A460")) +
  xlim(0, 1850) +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text.y = element_text(size = 22),
    axis.text.x = element_text(size = 22),
    axis.title = element_text(size = 23)
    )
dev.off()

```

## Visualizations by income group

```{r income group}

#-------------------------------------------------------------------------------
# papers
#-------------------------------------------------------------------------------

# 1. Prepare topic-level data (shares within income group)
topics_data <- papers %>%
  count(Income.group, category, name = "n") %>%   # counts per category
  rename(Topic = category) %>% 
  filter(!is.na(Income.group)) %>% 
  mutate(Income.group = factor(
    Income.group,
    levels = c("Low income", "Lower middle income", "Upper middle income", "High income"))) %>% 
  group_by(Income.group) %>% 
  mutate(share = n / sum(n))   # sum(n) is the grand total here

# 2. Prepare totals row data (absolute counts)
totals_data <- dataSummary %>%
  filter(!is.na(Income.group)) %>%
  group_by(Income.group) %>% 
  summarize(total = sum(n_papers, na.rm=T))

# 3. Define consistent factor levels for the y-axis
topic_levels <- c("Total papers", unique(topics_data$Topic))

# 4. Plot with two independent fill scales
pdf("plots/Figure2_category_paper_by_income.pdf", width = 10)
ggplot() +
  # --- top totals row ---
  geom_tile(data = totals_data,
            aes(x = Income.group, y = "Total papers", fill = total),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = totals_data,
    aes(x = Income.group, y = "Total papers",
        label = paste0("n=", total),
        color = ifelse(total > max(topics_data$total) * 0.4, "black", "black")), size = 4) +
  scale_fill_gradient(
    name = "Total papers",
    low = "#F6DBA7", high = "#F7B32B",
    breaks = range(totals_data$total),         
  labels = range(totals_data$total)) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(data = topics_data,
            aes(x = Income.group, y = Topic, fill = share),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = topics_data,
    aes(x = Income.group, y = Topic,
        label = scales::percent(share, accuracy = 1),
        color = ifelse(share > 0.25, "white", "black")),
    size = 4) +
  scale_fill_gradient(
    name = "Share within\nincome group",
    low = "#f7f4f9", high = "#8B475D",
    labels = scales::percent,
    breaks = c(min(topics_data$share), max(topics_data$share))) +
  scale_color_identity() +
labs(x = "Income group", y = NULL) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 30, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    legend.position = "top")

dev.off()

#-------------------------------------------------------------------------------
# surveys
#-------------------------------------------------------------------------------

# 1. Prepare topic-level data (shares within income group)
topics_data_s <- surveys %>%
  count(Income.group, category, name = "n") %>%   # counts per category
  rename(Topic = category) %>% 
  filter(!is.na(Income.group)) %>% 
  mutate(Income.group = factor(
    Income.group,
    levels = c("Low income", "Lower middle income", "Upper middle income", "High income"))) %>% 
  group_by(Income.group) %>% 
  mutate(share = n / sum(n))   # sum(n) is the grand total here


# 2. Prepare totals row data (absolute counts)
totals_data_s <- dataSummary %>%
  filter(!is.na(Income.group)) %>%
  group_by(Income.group) %>% 
  summarize(total_items = sum(n_surveys, na.rm=T))


# 3. Define consistent factor levels for the y-axis
topic_levels_s <- c("Total items", unique(topics_data_s$Topic))

# 4. Plot with two independent fill scales
pdf("plots/Figure2_category_survey_by_income.pdf", width = 10)
ggplot() +
  # --- top totals row ---
  geom_tile(data = totals_data_s,
            aes(x = Income.group, y = "Total items", fill = total_items),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = totals_data_s,
    aes(x = Income.group, y = "Total items",
        label = paste0("n=", total_items),
        color = ifelse(total_items > max(totals_data_s$total_items) * 0.4, "black", "black")), size = 4) +
  scale_fill_gradient(
    name = "Total items",
    low = "#F6DBA7", high = "#F7B32B",
    breaks = range(totals_data_s$total_items),         
  labels = range(totals_data_s$total_items)) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(data = topics_data_s,
            aes(x = Income.group, y = Topic, fill = share),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = topics_data_s,
    aes(x = Income.group, y = Topic,
        label = scales::percent(share, accuracy = 1),
        color = ifelse(share > 0.25, "white", "black")),
    size = 4) +
  scale_fill_gradient(
    name = "Share within\nincome group",
    low = "#F3EBF8", high = "#541F78",
    labels = scales::percent,
    breaks = c(min(topics_data_s$share), max(topics_data_s$share))) +
  scale_color_identity() +
labs(x = "Income group", y = NULL) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 30, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    legend.position = "top")

dev.off()

```

## Visualizations by income group, using share

```{r income share}

#-------------------------------------------------------------------------------
# papers
#-------------------------------------------------------------------------------

# 1. Prepare topic-level data (shares within income group, based on unique papers)
topics_data <- papers %>%
  filter(!is.na(Income.group)) %>% 
  distinct(ID, Income.group, category) %>%      # each paper counts once per (Income.group, category)
  count(Income.group, category, name = "n_papers") %>%   # number of papers mentioning category
  rename(Topic = category) %>%
  mutate(Income.group = factor(
    Income.group,
    levels = c("Low income", "Lower middle income", "Upper middle income", "High income")
  ))

# 2. Prepare totals row data (absolute counts of papers per income group)
totals_data <- dataSummary %>%
  filter(!is.na(Income.group)) %>%
  group_by(Income.group) %>% 
  summarize(total = sum(n_papers, na.rm = TRUE), .groups = "drop") %>%
  mutate(Income.group = factor(
    Income.group,
    levels = c("Low income", "Lower middle income", "Upper middle income", "High income")
  ))

topics_data <- topics_data %>%
  left_join(totals_data, by = "Income.group") %>%
  group_by(Income.group) %>%
  mutate(
    share = n_papers / total    # share of papers in that income group mentioning the topic
  ) %>%
  ungroup() %>%
  mutate(Income.group = factor(
    Income.group,
    levels = c("Low income", "Lower middle income", "Upper middle income", "High income")
  ),
  Topic = factor(
    Topic,
    levels = rev(c("Perceptions", "Behavior", "Priority", "Policy", "Health"))
  )
  )

    
# 3. Define consistent factor levels for the y-axis
# topic_levels <- c("Total papers", unique(topics_data$Topic))

pdf("plots/Figure2_category_paper_by_income_share.pdf", width = 12, height = 10)
ggplot() +
  # --- top totals row ---
  geom_tile(data = totals_data,
            aes(x = Income.group, y = "Total papers", fill = total),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = totals_data,
    aes(x = Income.group, y = "Total papers",
        label = paste0("n=", total),
        color = "black"),
    size = 7
  ) +
  scale_fill_gradient(
    name = "Total papers",
    low = "#F6DBA7", high = "#F7B32B",
    breaks = range(totals_data$total),
    labels = range(totals_data$total)
  ) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(data = topics_data,
            aes(x = Income.group, y = Topic, fill = share),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = topics_data,
    aes(x = Income.group, y = Topic,
        label = scales::percent(share, accuracy = 1),
        # label = paste0(
        #     scales::percent(share, accuracy = 1), 
        #     "\n(", n_papers, ")"
        #   ),
        color = ifelse(share > 0.25, "white", "black")),
    size = 7
  ) +
  scale_fill_gradient(
    name = "Share of papers\nwithin income group ",
    low = "#f7f4f9", high = "#8B475D",
    labels = scales::percent,
    breaks = c(min(topics_data$share), max(topics_data$share))
  ) +
  scale_color_identity() +
  labs(x = "Income group", y = NULL) +
  theme_minimal(base_size = 19) +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 30, hjust = 1, size = 22),
    axis.text.y = element_text(size = 22),
    axis.title = element_text(size = 22),
    legend.position = "top"
  )
dev.off()

#-------------------------------------------------------------------------------
# surveys
#-------------------------------------------------------------------------------

# 1. Prepare topic-level data (shares within income group, based on unique survey items)
surveys_topics <- surveys %>%
  filter(!is.na(Income.group)) %>%
  mutate(item_id = paste0(iso3, id, year)) %>%              # unique survey-level ID
  distinct(item_id, Income.group, category) %>%       # each item counts once per (Income.group, category)
  count(Income.group, category, name = "n_items") %>% # number of items mentioning category
  rename(Topic = category) %>%
  mutate(
    Income.group = factor(
      Income.group,
      levels = c("Low income", "Lower middle income", "Upper middle income", "High income")
    ),
    Topic = factor(
      Topic,
      levels = rev(c("Perceptions", "Behavior", "Priority", "Policy", "Health"))
    )
  )

# 2. Totals per income group (unique items)
surveys_totals <- surveys %>%
  filter(!is.na(Income.group)) %>%
  mutate(item_id = paste0(iso3, id, year)) %>%
  group_by(Income.group) %>%
  summarise(
    total = n_distinct(item_id),
    .groups = "drop"
  ) %>%
  mutate(
    Income.group = factor(
      Income.group,
      levels = c("Low income", "Lower middle income", "Upper middle income", "High income")
    )
  )

surveys_topics <- surveys_topics %>%
  left_join(surveys_totals, by = "Income.group") %>%
  group_by(Income.group) %>%
  mutate(
    share = n_items / total   # share of survey items in that income group mentioning the topic
  ) %>%
  ungroup()

pdf("plots/Figure2_category_survey_by_income_share.pdf", width = 12, height = 10)
ggplot() +
  # --- top totals row ---
  geom_tile(data = surveys_totals,
            aes(x = Income.group, y = "Total items", fill = total),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = surveys_totals,
    aes(x = Income.group, y = "Total items",
        label = paste0("n=", total),
        color = "black"),
    size = 7
  ) +
  scale_fill_gradient(
    name = "Total items",
    low = "#F6DBA7", high = "#F7B32B",
    breaks = range(surveys_totals$total),
    labels = range(surveys_totals$total)
  ) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(data = surveys_topics,
            aes(x = Income.group, y = Topic, fill = share),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = surveys_topics,
    aes(x = Income.group, y = Topic,
        label = scales::percent(share, accuracy = 1),
        # label = paste0(
        #     scales::percent(share, accuracy = 1), 
        #     "\n(", n_papers, ")"
        #   ),
        color = ifelse(share > 0.25, "white", "black")),
    size = 7
  ) +
  scale_fill_gradient(
    name = "Share of items\nwithin income group ",
    low = "#f7f4f9", high = "#541F78",
    labels = scales::percent,
    breaks = c(min(surveys_topics$share), max(surveys_topics$share))
  ) +
  scale_color_identity() +
  labs(x = "Income group", y = NULL) +
  theme_minimal(base_size = 19) +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 30, hjust = 1, size = 22),
    axis.text.y = element_text(size = 22),
    axis.title = element_text(size = 22),
    legend.position = "top"
  )
dev.off()

```





## Visualizations by exposure group

```{r exposure group}

#-------------------------------------------------------------------------------
# papers
#-------------------------------------------------------------------------------

# 1. Prepare topic-level data (shares within exposure group)
topics_data_poll <- papers %>%
  count(categoryPollution, category, name = "n") %>%   # counts per category
  rename(Topic = category) %>% 
  filter(!is.na(categoryPollution)) %>% 
  group_by(categoryPollution) %>% 
  mutate(share = n / sum(n))   # sum(n) is the grand total here

# 2. Prepare totals row data (absolute counts)
totals_data_poll <- dataSummary %>%
  filter(!is.na(categoryPollution)) %>%
  group_by(categoryPollution) %>% 
  summarize(total = sum(n_papers, na.rm=T))

# 3. Define consistent factor levels for the y-axis
topic_levels <- c("Total papers", unique(topics_data_poll$Topic))

# 4. Plot with two independent fill scales
pdf("plots/Figure2_category_paper_by_exposure.pdf", width = 10)
ggplot() +
  # --- top totals row ---
  geom_tile(data = totals_data_poll,
            aes(x = categoryPollution, y = "Total papers", fill = total),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = totals_data_poll,
    aes(x = categoryPollution, y = "Total papers",
        label = paste0("n=", total),
        color = ifelse(total > max(topics_data_poll$total) * 0.4, "black", "black")), size = 4) +
  scale_fill_gradient(
    name = "Total papers",
    low = "#F6DBA7", high = "#F7B32B",
    breaks = range(totals_data_poll$total),         
  labels = range(totals_data_poll$total)) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(data = topics_data_poll,
            aes(x = categoryPollution, y = Topic, fill = share),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = topics_data_poll,
    aes(x = categoryPollution, y = Topic,
        label = scales::percent(share, accuracy = 1),
        color = ifelse(share > 0.25, "white", "black")),
    size = 4) +
  scale_fill_gradient(
    name = "Share within\nexposure group",
    low = "#f7f4f9", high = "#8B475D",
    labels = scales::percent,
    breaks = c(min(topics_data_poll$share), max(topics_data_poll$share))) +
  scale_color_identity() +
labs(x = "Exposure group", y = NULL) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 30, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    legend.position = "top")

dev.off()

#-------------------------------------------------------------------------------
# surveys
#-------------------------------------------------------------------------------

# 1. Prepare topic-level data (shares within exposure group)
topics_data_poll_s <- surveys %>%
  count(categoryPollution, category, name = "n") %>%   # counts per category
  rename(Topic = category) %>% 
  filter(!is.na(categoryPollution)) %>% 
  group_by(categoryPollution) %>% 
  mutate(share = n / sum(n))   # sum(n) is the grand total here

# 2. Prepare totals row data (absolute counts)
totals_data_poll_s <- dataSummary %>%
  filter(!is.na(categoryPollution)) %>%
  group_by(categoryPollution) %>% 
  summarize(total_items = sum(n_surveys, na.rm=T))

# 3. Define consistent factor levels for the y-axis
topic_levels_s <- c("Total items", unique(topics_data_poll_s$Topic))

# 4. Plot with two independent fill scales
pdf("plots/Figure2_category_survey_by_exposure.pdf", width = 10)
ggplot() +
  # --- top totals row ---
  geom_tile(data = totals_data_poll_s,
            aes(x = categoryPollution, y = "Total items", fill = total_items),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = totals_data_poll_s,
    aes(x = categoryPollution, y = "Total items",
        label = paste0("n=", total_items),
        color = ifelse(total_items > max(totals_data_poll_s$total_items) * 0.4, "black", "black")), size = 4) +
  scale_fill_gradient(
    name = "Total items",
    low = "#F6DBA7", high = "#F7B32B",
    breaks = range(totals_data_poll_s$total_items),         
  labels = range(totals_data_poll_s$total_items)) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(data = topics_data_poll_s,
            aes(x = categoryPollution, y = Topic, fill = share),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = topics_data_poll_s,
    aes(x = categoryPollution, y = Topic,
        label = scales::percent(share, accuracy = 1),
        color = ifelse(share > 0.25, "white", "black")),
    size = 4) +
  scale_fill_gradient(
    name = "Share within\nexposure group",
    low = "#F3EBF8", high = "#541F78",
    labels = scales::percent,
    breaks = c(min(topics_data_poll_s$share), max(topics_data_poll_s$share))) +
  scale_color_identity() +
labs(x = "Exposure group", y = NULL) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 30, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    legend.position = "top")

dev.off()

```


## per exposure level using shares

```{r exposure level shares}

#-------------------------------------------------------------------------------
# papers
#-------------------------------------------------------------------------------

# 1. Prepare topic-level data (shares within exposure group, based on unique papers)
topics_data_poll <- papers %>%
  filter(!is.na(categoryPollution)) %>%
  distinct(ID, categoryPollution, category) %>%          # each paper counts once per (exposure, category)
  count(categoryPollution, category, name = "n_papers") %>%   # number of papers mentioning category
  rename(Topic = category) %>%
  mutate(
    # if you want a specific topic order, same as income plot:
    Topic = factor(
      Topic,
      levels = rev(c("Perceptions", "Behavior", "Priority", "Policy", "Health"))
    )
  )

# 2. Prepare totals row data (absolute counts of papers per exposure group)
totals_data_poll <- dataSummary %>%
  filter(!is.na(categoryPollution)) %>%
  group_by(categoryPollution) %>%
  summarize(total = sum(n_papers, na.rm = TRUE), .groups = "drop")

# 3. Add shares within exposure group (based on unique papers)
topics_data_poll <- topics_data_poll %>%
  left_join(totals_data_poll, by = "categoryPollution") %>%
  group_by(categoryPollution) %>%
  mutate(
    share = n_papers / total   # share of papers in that exposure group mentioning the topic
  ) %>%
  ungroup()

# 4. Plot with two independent fill scales
pdf("plots/Figure2_category_paper_by_exposure_share.pdf", width = 12, height = 10)
ggplot() +
  # --- top totals row ---
  geom_tile(
    data = totals_data_poll,
    aes(x = categoryPollution, y = "Total papers", fill = total),
    color = "white", linewidth = 0.8
  ) +
  geom_text(
    data = totals_data_poll,
    aes(
      x = categoryPollution,
      y = "Total papers",
      label = paste0("n=", total),
      color = "black"
    ),
    size = 7
  ) +
  scale_fill_gradient(
    name  = "Total papers",
    low   = "#F6DBA7",
    high  = "#F7B32B",
    breaks = range(totals_data_poll$total),
    labels = range(totals_data_poll$total)
  ) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(
    data = topics_data_poll,
    aes(x = categoryPollution, y = Topic, fill = share),
    color = "white", linewidth = 0.8
  ) +
  geom_text(
    data = topics_data_poll,
    aes(
      x = categoryPollution,
      y = Topic,
      # OPTION 1: percentage only (like your current income plot)
      label = scales::percent(share, accuracy = 1),
      # OPTION 2: uncomment this instead for "percent\n(n_papers)"
      # label = paste0(
      #   scales::percent(share, accuracy = 1),
      #   "\n(", n_papers, ")"
      # ),
      color = ifelse(share > 0.25, "white", "black")
    ),
    size = 7
  ) +
  scale_fill_gradient(
    name   = "Share of papers\nwithin exposure group ",
    low    = "#f7f4f9",
    high   = "#8B475D",
    labels = scales::percent,
    breaks = c(min(topics_data_poll$share), max(topics_data_poll$share))
  ) +
  scale_color_identity() +
  labs(x = "Exposure group", y = NULL) +
  theme_minimal(base_size = 19) +
  theme(
    panel.grid   = element_blank(),
    axis.text.x  = element_text(angle = 30, hjust = 1, size = 22),
    axis.text.y  = element_text(size = 22),
    axis.title   = element_text(size = 22),
    legend.position = "top"
  )
dev.off()

#-------------------------------------------------------------------------------
# surveys
#-------------------------------------------------------------------------------

# 1. Prepare topic-level data (shares within exposure group, based on unique survey items)
topics_data_survey_poll <- surveys %>%
  filter(!is.na(categoryPollution)) %>%
  mutate(item_id = paste0(iso3, id, year)) %>%                      # unique survey item ID
  distinct(item_id, categoryPollution, category) %>%          # each item counts once per (exposure, topic)
  count(categoryPollution, category, name = "n_items") %>%    # number of items mentioning category
  rename(Topic = category) %>%
  mutate(
    # optional: topic order, same as your income-group plot
    Topic = factor(
      Topic,
      levels = rev(c("Perceptions", "Behavior", "Priority", "Policy", "Health"))
    )
    # optional: control exposure group order, e.g.:
    # categoryPollution = factor(
    #   categoryPollution,
    #   levels = c("Air pollution", "Water pollution", "Other")  # adjust to your data
    # )
  )

# 2. Prepare totals row data (absolute counts of unique items per exposure group)
totals_data_survey_poll <- surveys %>%
  filter(!is.na(categoryPollution)) %>%
  mutate(item_id = paste0(iso3, id, year)) %>%
  group_by(categoryPollution) %>%
  summarise(
    total = n_distinct(item_id),
    .groups = "drop"
  )
  # optional: match factor ordering here too
  # %>%
  # mutate(
  #   categoryPollution = factor(
  #     categoryPollution,
  #     levels = c("Air pollution", "Water pollution", "Other")
  #   )
  # )

# 3. Add shares within exposure group (based on unique items)
topics_data_survey_poll <- topics_data_survey_poll %>%
  left_join(totals_data_survey_poll, by = "categoryPollution") %>%
  group_by(categoryPollution) %>%
  mutate(
    share = n_items / total   # share of survey items in that exposure group mentioning the topic
  ) %>%
  ungroup()

# 4. Plot with two independent fill scales
pdf("plots/Figure2_category_item_by_exposure_share.pdf", width = 12, height = 10)
ggplot() +
  # --- top totals row ---
  geom_tile(
    data = totals_data_survey_poll,
    aes(x = categoryPollution, y = "Total items", fill = total),
    color = "white", linewidth = 0.8
  ) +
  geom_text(
    data = totals_data_survey_poll,
    aes(
      x = categoryPollution,
      y = "Total items",
      label = paste0("n=", total),
      color = "black"
    ),
    size = 7
  ) +
  scale_fill_gradient(
    name   = "Total items",
    low    = "#F6DBA7",
    high   = "#F7B32B",
    breaks = range(totals_data_survey_poll$total),
    labels = range(totals_data_survey_poll$total)
  ) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(
    data = topics_data_survey_poll,
    aes(x = categoryPollution, y = Topic, fill = share),
    color = "white", linewidth = 0.8
  ) +
  geom_text(
    data = topics_data_survey_poll,
    aes(
      x = categoryPollution,
      y = Topic,
      # OPTION 1: percentage only (mirroring your income-group code)
      label = scales::percent(share, accuracy = 1),
      # OPTION 2: percentage + underlying n_items
      # label = paste0(
      #   scales::percent(share, accuracy = 1),
      #   "\n(", n_items, ")"
      # ),
      color = ifelse(share > 0.25, "white", "black")
    ),
    size = 7
  ) +
  scale_fill_gradient(
    name   = "Share of items\nwithin exposure group ",
    low    = "#f7f4f9",
    high   = "#541F78",
    labels = scales::percent,
    breaks = c(min(topics_data_survey_poll$share), max(topics_data_survey_poll$share))
  ) +
  scale_color_identity() +
  labs(x = "Exposure group", y = NULL) +
  theme_minimal(base_size = 19) +
  theme(
    panel.grid    = element_blank(),
    axis.text.x   = element_text(angle = 30, hjust = 1, size = 22),
    axis.text.y   = element_text(size = 22),
    axis.title    = element_text(size = 22),
    legend.position = "top"
  )

dev.off()





```





