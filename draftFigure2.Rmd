---
title: "Figure two"
author: "Ella Henninger & Camille Fournier"
date: "2025-10-17"
output: html_document
---


```{r setup, include=FALSE}

## clean environment
rm(list = ls())

# Define which packages needed for analyses
p_needed <-
  c("knitr",
    "dplyr", 
    "stargazer",
    "ggplot2",
    "viridis",
    "haven",
    "MASS",
    "modelsummary",
    "tidyr",
    "data.table",
    "scales",
    "tidyverse",
    "treemapify",
    "ggnewscale")

# Check which packages are already installed on your computer
packages <- rownames(installed.packages())

# Check which packages are not installed
p_to_install <- p_needed[!(p_needed %in% packages)]

if (length(p_to_install) > 0) {
  install.packages(p_to_install)
}
sapply(p_needed, require, character.only = TRUE)


# Set an option for the final document that can be produced from the .Rmd file.
knitr::opts_chunk$set(echo = TRUE)

## For replicability: session information 
session_info <- print(sessionInfo())
```

## Load the data

```{r data}

"%ni%" = Negate("%in%")

#-------------------------------------------------------------------------------
# Load the data
#-------------------------------------------------------------------------------
papers <- read.csv2("output/paperClassifYear.csv", 
                    header = T, sep = ",", dec = ".")

surveys <- read.csv2("output/surveyClassifYear.csv", 
                     header = T, sep = ",", dec = ".")

dataSummary <- read.csv("output/datasetPlots.csv")

papers <- papers %>% 
  filter(!is.na(iso3))

surveys <- surveys %>% 
  filter(!is.na(iso3))

dataSummary <- dataSummary %>% 
  filter(!is.na(iso3))

dataSummary$categoryPollution <- ifelse(
  !is.na(dataSummary$categoryPollution),
  paste0(toupper(substr(dataSummary$categoryPollution, 1, 1)),
         substr(dataSummary$categoryPollution, 2, nchar(dataSummary$categoryPollution))),
  NA
)

dataSummary$categoryPollution <- factor(
  dataSummary$categoryPollution,
  levels = rev(c(
    "Very high",
    "High",
    "Medium",
    "Low",
    "Very low"
  )),
  ordered = TRUE
)

papers <- merge(papers, dataSummary, by = "iso3", all.x = T, all.y = F)
surveys <- merge(surveys, dataSummary, by = "iso3", all.x = T, all.y = F)

```

## Filter (only Inclusion = 1 items)

```{r clean}

#-------------------------------------------------------------------------------
# Inclusion = 1 for survey items 
#-------------------------------------------------------------------------------

## surveys: drop items for which Inclusion == 0
surveys <- surveys[which(surveys$Inclusion == 1),] # done in the data prep section

## subset survey without Flashbarometer
# surveys_sub <- surveys[which(surveys$source != "Flash Eurobarometer 360: Attitudes of Europeans towards air quality"),]

```

## Visualization counting the share of papers & survey items mentioned instead of the raw count for each category

```{r}

#-------------------------------------------------------------------------------
# papers
#-------------------------------------------------------------------------------

papers_long <- papers %>%
  group_by(category) %>%
  summarise(n = n_distinct(ID)) %>%
  rename(Topic = category) %>% 
  mutate(share = n / length(unique(papers$ID)))

p1 <- ggplot(papers_long, aes(y = reorder(Topic, n), x = n, fill = Topic)) +
  geom_col(color = "black") +
  geom_text(aes(label = percent(share, accuracy = 1)),
            hjust = -0.3, size = 5) +
  labs(y = NULL, x = "Percentage of topics covered in papers") +
  scale_fill_manual(values = c(
    "Perceptions" = "#8B7B8B",
    "Behavior"    = "#EED8AE",
    "Priority"    = "#CDB5CD",
    "Policy"      = "#CD919E",
    "Health"      = "#8B475D",
    "None"        = "#F4A460")) +
  theme_minimal() +
  xlim(0, 450) +
  theme(
    legend.position = "none",
    axis.text.y = element_text(size = 22),
    axis.text.x = element_text(size = 22),
    axis.title = element_text(size = 23)
    )


# bar plot with counts and percentage labels
pdf("plots/Figure2_category_paper_barplot_share.pdf", width = 12, height = 10)
p1
dev.off()

ggsave(plot = p1 + 
         theme(
           legend.position = "none",
           axis.text.y = element_text(size = 14),
           axis.text.x = element_text(size = 14),
           axis.title = element_text(size = 14)
         ),
       filename = paste("plots/Figure2_category_paper_barplot_share.png", sep = ""),
       dpi=600, width = 14, height = 10, units='cm')

#-------------------------------------------------------------------------------
# surveys
#-------------------------------------------------------------------------------

surveys_long <- surveys %>%
  mutate(item_id = paste0(iso3, id, year)) %>% 
  distinct(item_id, category) %>%     # collapse multiple rows for same ID–category pair
  count(category, name = "n") %>% 
  mutate(share = n / length(unique(paste0(surveys$iso3, surveys$id, surveys$year)))) %>%
  rename(Topic = category)

# bar plot with counts and percentage labels
p2 <- ggplot(surveys_long, aes(y = reorder(Topic, n), x = n, fill = Topic)) +
  geom_col(color = "black") +
  geom_text(aes(label = percent(share, accuracy = 1)),
            hjust = -0.3, size = 5) +
  labs(y = NULL, x = "Percentage of topics covered in survey items") +
  scale_fill_manual(values = c(
    "Perceptions" = "#8B7B8B",
    "Behavior"    = "#EED8AE",
    "Priority"    = "#CDB5CD",
    "Policy"      = "#CD919E",
    "Health"      = "#8B475D",
    "None"        = "#F4A460")) +
  xlim(0, 2100) +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text.y = element_text(size = 22),
    axis.text.x = element_text(size = 22),
    axis.title = element_text(size = 23)
    )


pdf("plots/Figure2_category_survey_barplot_share.pdf", width = 12, height = 10)
p2
dev.off()

ggsave(plot = p2 + 
         theme(
           legend.position = "none",
           axis.text.y = element_text(size = 14),
           axis.text.x = element_text(size = 14),
           axis.title = element_text(size = 14)
         ),
       filename = paste("plots/Figure2_category_survey_barplot_share.png", sep = ""),
       dpi=600, width = 14, height = 10, units='cm')


```

## Visualization counting the share of papers & survey items mentioned instead of the raw count for each category -- removing Ind Chn Eurob

```{r}

#-------------------------------------------------------------------------------
# papers
#-------------------------------------------------------------------------------

papers_long <- papers %>%
  filter(country %ni% c("China", "India")) %>% 
  group_by(category) %>%
  summarise(n = n_distinct(ID)) %>%
  rename(Topic = category) %>% 
  mutate(share = n / length(unique(
    subset(papers, country %ni% c("China", "India"))$ID)))

p1 <- ggplot(papers_long, aes(y = reorder(Topic, n), x = n, fill = Topic)) +
  geom_col(color = "black") +
  geom_text(aes(label = percent(share, accuracy = 1)),
            hjust = -0.3, size = 5) +
  labs(y = NULL, x = "Percentage of topics covered in papers") +
  scale_fill_manual(values = c(
    "Perceptions" = "#8B7B8B",
    "Behavior"    = "#EED8AE",
    "Priority"    = "#CDB5CD",
    "Policy"      = "#CD919E",
    "Health"      = "#8B475D",
    "None"        = "#F4A460")) +
  theme_minimal() +
  xlim(0, 320) +
  theme(
    legend.position = "none",
    axis.text.y = element_text(size = 22),
    axis.text.x = element_text(size = 22),
    axis.title = element_text(size = 23)
    )


# bar plot with counts and percentage labels
pdf("plots/Figure2_category_paper_barplot_share_noIndChn.pdf", width = 12, height = 10)
p1
dev.off()

ggsave(plot = p1 + 
         theme(
           legend.position = "none",
           axis.text.y = element_text(size = 14),
           axis.text.x = element_text(size = 14),
           axis.title = element_text(size = 14)
         ),
       filename = paste("plots/Figure2_category_paper_barplot_share_noIndChn.png", sep = ""),
       dpi=600, width = 14, height = 10, units='cm')

#-------------------------------------------------------------------------------
# surveys
#-------------------------------------------------------------------------------

surveysNoBarom <- surveys %>%
  filter(!(grepl("Eurobarometer", source, ignore.case = TRUE) | source == "Flash 123"))

surveys_long <- surveysNoBarom %>% 
  mutate(item_id = paste0(iso3, id, year)) %>% 
  distinct(item_id, category) %>%     # collapse multiple rows for same ID–category pair
  count(category, name = "n") %>% 
  mutate(share = n / length(unique(paste0(surveysNoBarom$iso3, surveysNoBarom$id, surveysNoBarom$year)))) %>%
  rename(Topic = category)

# bar plot with counts and percentage labels
p2 <- ggplot(surveys_long, aes(y = reorder(Topic, n), x = n, fill = Topic)) +
  geom_col(color = "black") +
  geom_text(aes(label = percent(share, accuracy = 1)),
            hjust = -0.3, size = 5) +
  labs(y = NULL, x = "Percentage of topics covered in survey items") +
  scale_fill_manual(values = c(
    "Perceptions" = "#8B7B8B",
    "Behavior"    = "#EED8AE",
    "Priority"    = "#CDB5CD",
    "Policy"      = "#CD919E",
    "Health"      = "#8B475D",
    "None"        = "#F4A460")) +
  xlim(0, 750) +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text.y = element_text(size = 22),
    axis.text.x = element_text(size = 22),
    axis.title = element_text(size = 23)
    )

pdf("plots/Figure2_category_survey_barplot_share_noEurob.pdf", width = 12, height = 10)
p2
dev.off()

ggsave(plot = p2 + 
         theme(
           legend.position = "none",
           axis.text.y = element_text(size = 14),
           axis.text.x = element_text(size = 14),
           axis.title = element_text(size = 14)
         ),
       filename = paste("plots/Figure2_category_survey_barplot_share_noEurob.png", sep = ""),
       dpi=600, width = 14, height = 10, units='cm')


```

## Visualizations by income group, using share --- ACTUAL PANELS USED IN FIG2

```{r income share}

#-------------------------------------------------------------------------------
# papers
#-------------------------------------------------------------------------------

# 1. Prepare topic-level data (shares within income group, based on unique papers)
topics_data <- papers %>%
  filter(!is.na(Income.group)) %>% 
  distinct(ID, Income.group, category) %>%      # each paper counts once per (Income.group, category)
  count(Income.group, category, name = "n_papers") %>%   # number of papers mentioning category
  rename(Topic = category) %>%
  mutate(Income.group = factor(
    Income.group,
    levels = c("Low income", "Lower middle income", "Upper middle income", "High income")
  ))

# 2. Prepare totals row data (absolute counts of papers per income group)
totals_data <- dataSummary %>%
  filter(!is.na(Income.group)) %>%
  group_by(Income.group) %>% 
  summarize(total = sum(n_papers, na.rm = TRUE), .groups = "drop") %>%
  mutate(Income.group = factor(
    Income.group,
    levels = c("Low income", "Lower middle income", "Upper middle income", "High income")
  ))

topics_data <- topics_data %>%
  left_join(totals_data, by = "Income.group") %>%
  group_by(Income.group) %>%
  mutate(
    share = n_papers / total    # share of papers in that income group mentioning the topic
  ) %>%
  ungroup() %>%
  mutate(Income.group = factor(
    Income.group,
    levels = c("Low income", "Lower middle income", "Upper middle income", "High income")
  ),
  Topic = factor(
    Topic,
    levels = rev(c("Perceptions", "Behavior", "Priority", "Policy", "Health"))
  )
  )

topics_data <- topics_data %>%
  mutate(
    Income.group = factor(
      Income.group,
      levels = c(
        "Low income",
        "Lower middle income",
        "Upper middle income",
        "High income"
      ),
      labels = c(
        "Low income",
        "Lower\nmiddle income",
        "Upper\nmiddle income",
        "High income"
      )
    )
  )
    
totals_data <- totals_data %>%
  mutate(
    Income.group = factor(
      Income.group,
      levels = c(
        "Low income",
        "Lower middle income",
        "Upper middle income",
        "High income"
      ),
      labels = c(
        "Low income",
        "Lower\nmiddle income",
        "Upper\nmiddle income",
        "High income"
      )
    )
  )


# 3. Define consistent factor levels for the y-axis
# topic_levels <- c("Total papers", unique(topics_data$Topic))
p3 <- ggplot() +
  # --- top totals row ---
  geom_tile(data = totals_data,
            aes(x = Income.group, y = "Total papers", fill = total),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = totals_data,
    aes(x = Income.group, y = "Total papers",
        label = paste0("n=", total),
        color = "black"),
    size = 5
  ) +
  scale_fill_gradient(
    name = "Total papers",
    low = "#F6DBA7", high = "#F7B32B",
    breaks = range(totals_data$total),
    labels = range(totals_data$total)
  ) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(data = topics_data,
            aes(x = Income.group, y = Topic, fill = share),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = topics_data,
    aes(x = Income.group, y = Topic,
        label = scales::percent(share, accuracy = 1),
        # label = paste0(
        #     scales::percent(share, accuracy = 1), 
        #     "\n(", n_papers, ")"
        #   ),
        color = ifelse(share > 0.25, "white", "black")),
    size = 5
  ) +
  scale_fill_gradient(
    name = "Share of papers\nwithin income group ",
    low = "#f7f4f9", high = "#8B475D",
    labels = scales::percent,
    breaks = c(min(topics_data$share), max(topics_data$share))
  ) +
  scale_color_identity() +
  labs(x = "Income group", y = NULL) +
  theme_minimal(base_size = 19) +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(size = 22),
    axis.text.y = element_text(size = 22),
    axis.title = element_text(size = 22),
    legend.position = "top"
  )

pdf("plots/Figure2_category_paper_by_income_share.pdf", width = 12, height = 10)
p3
dev.off()

ggsave(plot = p3 + 
         theme(
           legend.position = "none",
           axis.text.y = element_text(size = 12),
           axis.text.x = element_text(size = 12),
           axis.title = element_text(size = 12)
         ),
       filename = paste("plots/Figure2_category_paper_by_income_share.png", sep = ""),
       dpi=600, width = 16, height = 10, units='cm')

#-------------------------------------------------------------------------------
# surveys
#-------------------------------------------------------------------------------

# 1. Prepare topic-level data (shares within income group, based on unique survey items)
surveys_topics <- surveys %>%
  filter(!is.na(Income.group)) %>%
  mutate(item_id = paste0(iso3, id, year)) %>%              # unique survey-level ID
  distinct(item_id, Income.group, category) %>%       # each item counts once per (Income.group, category)
  count(Income.group, category, name = "n_items") %>% # number of items mentioning category
  rename(Topic = category) %>%
  mutate(
    Income.group = factor(
      Income.group,
      levels = c("Low income", "Lower middle income", "Upper middle income", "High income")
    ),
    Topic = factor(
      Topic,
      levels = rev(c("Perceptions", "Behavior", "Priority", "Policy", "Health"))
    )
  )

# 2. Totals per income group (unique items)
surveys_totals <- surveys %>%
  filter(!is.na(Income.group)) %>%
  mutate(item_id = paste0(iso3, id, year)) %>%
  group_by(Income.group) %>%
  summarise(
    total = n_distinct(item_id),
    .groups = "drop"
  ) %>%
  mutate(
    Income.group = factor(
      Income.group,
      levels = c("Low income", "Lower middle income", "Upper middle income", "High income")
    )
  )

surveys_topics <- surveys_topics %>%
  left_join(surveys_totals, by = "Income.group") %>%
  group_by(Income.group) %>%
  mutate(
    share = n_items / total   # share of survey items in that income group mentioning the topic
  ) %>%
  ungroup()

surveys_topics <- surveys_topics %>%
  mutate(
    Income.group = factor(
      Income.group,
      levels = c(
        "Low income",
        "Lower middle income",
        "Upper middle income",
        "High income"
      ),
      labels = c(
        "Low income",
        "Lower\nmiddle income",
        "Upper\nmiddle income",
        "High income"
      )
    )
  )

surveys_totals <- surveys_totals %>%
  mutate(
    Income.group = factor(
      Income.group,
      levels = c(
        "Low income",
        "Lower middle income",
        "Upper middle income",
        "High income"
      ),
      labels = c(
        "Low income",
        "Lower\nmiddle income",
        "Upper\nmiddle income",
        "High income"
      )
    )
  )


p4 <- ggplot() +
  # --- top totals row ---
  geom_tile(data = surveys_totals,
            aes(x = Income.group, y = "Total items", fill = total),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = surveys_totals,
    aes(x = Income.group, y = "Total items",
        label = paste0("n=", total),
        color = "black"),
    size = 5
  ) +
  scale_fill_gradient(
    name = "Total items",
    low = "#F6DBA7", high = "#F7B32B",
    breaks = range(surveys_totals$total),
    labels = range(surveys_totals$total)
  ) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(data = surveys_topics,
            aes(x = Income.group, y = Topic, fill = share),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = surveys_topics,
    aes(x = Income.group, y = Topic,
        label = scales::percent(share, accuracy = 1),
        # label = paste0(
        #     scales::percent(share, accuracy = 1), 
        #     "\n(", n_papers, ")"
        #   ),
        color = ifelse(share > 0.25, "white", "black")),
    size = 5
  ) +
  scale_fill_gradient(
    name = "Share of items\nwithin income group ",
    low = "#f7f4f9", high = "#541F78",
    labels = scales::percent,
    breaks = c(min(surveys_topics$share), max(surveys_topics$share))
  ) +
  scale_color_identity() +
  labs(x = "Income group", y = NULL) +
  theme_minimal(base_size = 19) +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(size = 22),
    axis.text.y = element_text(size = 22),
    axis.title = element_text(size = 22),
    legend.position = "top"
  )

pdf("plots/Figure2_category_survey_by_income_share.pdf", width = 12, height = 10)
p4
dev.off()

ggsave(plot = p4 + 
         theme(
           legend.position = "none",
           axis.text.y = element_text(size = 12),
           axis.text.x = element_text(size = 12),
           axis.title = element_text(size = 12)
         ),
       filename = paste("plots/Figure2_category_survey_by_income_share.png", sep = ""),
       dpi=600, width = 16, height = 10, units='cm')


```

## Visualizations by income group, using share, removing india and china and eurobarometer --- SUPP fig

```{r income share}

#-------------------------------------------------------------------------------
# papers
#-------------------------------------------------------------------------------

# 1. Prepare topic-level data (shares within income group, based on unique papers)
topics_data <- papers %>%
  filter(!is.na(Income.group)) %>% 
  filter(country %ni% c("China", "India")) %>% 
  distinct(ID, Income.group, category) %>%      # each paper counts once per (Income.group, category)
  count(Income.group, category, name = "n_papers") %>%   # number of papers mentioning category
  rename(Topic = category) %>%
  mutate(Income.group = factor(
    Income.group,
    levels = c("Low income", "Lower middle income", "Upper middle income", "High income")
  ))

# 2. Prepare totals row data (absolute counts of papers per income group)
totals_data <- dataSummary %>%
  filter(!is.na(Income.group)) %>%
  filter(countryName %ni% c("China", "India")) %>% 
  group_by(Income.group) %>% 
  summarize(total = sum(n_papers, na.rm = TRUE), .groups = "drop") %>%
  mutate(Income.group = factor(
    Income.group,
    levels = c("Low income", "Lower middle income", "Upper middle income", "High income")
  ))

topics_data <- topics_data %>%
  left_join(totals_data, by = "Income.group") %>%
  group_by(Income.group) %>%
  mutate(
    share = n_papers / total    # share of papers in that income group mentioning the topic
  ) %>%
  ungroup() %>%
  mutate(Income.group = factor(
    Income.group,
    levels = c("Low income", "Lower middle income", "Upper middle income", "High income")
  ),
  Topic = factor(
    Topic,
    levels = rev(c("Perceptions", "Behavior", "Priority", "Policy", "Health"))
  )
  )

topics_data <- topics_data %>%
  mutate(
    Income.group = factor(
      Income.group,
      levels = c(
        "Low income",
        "Lower middle income",
        "Upper middle income",
        "High income"
      ),
      labels = c(
        "Low income",
        "Lower\nmiddle income",
        "Upper\nmiddle income",
        "High income"
      )
    )
  )
    
totals_data <- totals_data %>%
  mutate(
    Income.group = factor(
      Income.group,
      levels = c(
        "Low income",
        "Lower middle income",
        "Upper middle income",
        "High income"
      ),
      labels = c(
        "Low income",
        "Lower\nmiddle income",
        "Upper\nmiddle income",
        "High income"
      )
    )
  )


# 3. Define consistent factor levels for the y-axis
# topic_levels <- c("Total papers", unique(topics_data$Topic))
p3 <- ggplot() +
  # --- top totals row ---
  geom_tile(data = totals_data,
            aes(x = Income.group, y = "Total papers", fill = total),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = totals_data,
    aes(x = Income.group, y = "Total papers",
        label = paste0("n=", total),
        color = "black"),
    size = 5
  ) +
  scale_fill_gradient(
    name = "Total papers",
    low = "#F6DBA7", high = "#F7B32B",
    breaks = range(totals_data$total),
    labels = range(totals_data$total)
  ) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(data = topics_data,
            aes(x = Income.group, y = Topic, fill = share),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = topics_data,
    aes(x = Income.group, y = Topic,
        label = scales::percent(share, accuracy = 1),
        # label = paste0(
        #     scales::percent(share, accuracy = 1), 
        #     "\n(", n_papers, ")"
        #   ),
        color = ifelse(share > 0.25, "white", "black")),
    size = 5
  ) +
  scale_fill_gradient(
    name = "Share of papers\nwithin income group ",
    low = "#f7f4f9", high = "#8B475D",
    labels = scales::percent,
    breaks = c(min(topics_data$share), max(topics_data$share))
  ) +
  scale_color_identity() +
  labs(x = "Income group", y = NULL) +
  theme_minimal(base_size = 19) +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(size = 22),
    axis.text.y = element_text(size = 22),
    axis.title = element_text(size = 22),
    legend.position = "top"
  )

pdf("plots/Figure2_category_paper_by_income_share_noIndChn.pdf", width = 12, height = 10)
p3
dev.off()

ggsave(plot = p3 + 
         theme(
           legend.position = "none",
           axis.text.y = element_text(size = 12),
           axis.text.x = element_text(size = 12),
           axis.title = element_text(size = 12)
         ),
       filename = paste("plots/Figure2_category_paper_by_income_share_noIndChn.png", sep = ""),
       dpi=600, width = 16, height = 10, units='cm')

#-------------------------------------------------------------------------------
# surveys
#-------------------------------------------------------------------------------

# 1. Prepare topic-level data (shares within income group, based on unique survey items)
surveys_topics <- surveys %>%
  filter(!is.na(Income.group)) %>%
  mutate(eurobarometerSource = ifelse(grepl("Eurobarometer", source, ignore.case = TRUE) | source == "Flash 123", 1, 0)) %>% 
  filter(eurobarometerSource != 1) %>%
  mutate(item_id = paste0(iso3, id, year)) %>%              # unique survey-level ID
  distinct(item_id, Income.group, category) %>%       # each item counts once per (Income.group, category)
  count(Income.group, category, name = "n_items") %>% # number of items mentioning category
  rename(Topic = category) %>%
  mutate(
    Income.group = factor(
      Income.group,
      levels = c("Low income", "Lower middle income", "Upper middle income", "High income")
    ),
    Topic = factor(
      Topic,
      levels = rev(c("Perceptions", "Behavior", "Priority", "Policy", "Health"))
    )
  )

# 2. Totals per income group (unique items)
surveys_totals <- surveys %>%
  filter(!is.na(Income.group)) %>%
  mutate(eurobarometerSource = ifelse(grepl("Eurobarometer", source, ignore.case = TRUE) | source == "Flash 123", 1, 0)) %>% 
  filter(eurobarometerSource != 1) %>%
  mutate(item_id = paste0(iso3, id, year)) %>%
  group_by(Income.group) %>%
  summarise(
    total = n_distinct(item_id),
    .groups = "drop"
  ) %>%
  mutate(
    Income.group = factor(
      Income.group,
      levels = c("Low income", "Lower middle income", "Upper middle income", "High income")
    )
  )

surveys_topics <- surveys_topics %>%
  left_join(surveys_totals, by = "Income.group") %>%
  group_by(Income.group) %>%
  mutate(
    share = n_items / total   # share of survey items in that income group mentioning the topic
  ) %>%
  ungroup()

surveys_topics <- surveys_topics %>%
  mutate(
    Income.group = factor(
      Income.group,
      levels = c(
        "Low income",
        "Lower middle income",
        "Upper middle income",
        "High income"
      ),
      labels = c(
        "Low income",
        "Lower\nmiddle income",
        "Upper\nmiddle income",
        "High income"
      )
    )
  )

surveys_totals <- surveys_totals %>%
  mutate(
    Income.group = factor(
      Income.group,
      levels = c(
        "Low income",
        "Lower middle income",
        "Upper middle income",
        "High income"
      ),
      labels = c(
        "Low income",
        "Lower\nmiddle income",
        "Upper\nmiddle income",
        "High income"
      )
    )
  )


p4 <- ggplot() +
  # --- top totals row ---
  geom_tile(data = surveys_totals,
            aes(x = Income.group, y = "Total items", fill = total),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = surveys_totals,
    aes(x = Income.group, y = "Total items",
        label = paste0("n=", total),
        color = "black"),
    size = 5
  ) +
  scale_fill_gradient(
    name = "Total items",
    low = "#F6DBA7", high = "#F7B32B",
    breaks = range(surveys_totals$total),
    labels = range(surveys_totals$total)
  ) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(data = surveys_topics,
            aes(x = Income.group, y = Topic, fill = share),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = surveys_topics,
    aes(x = Income.group, y = Topic,
        label = scales::percent(share, accuracy = 1),
        # label = paste0(
        #     scales::percent(share, accuracy = 1), 
        #     "\n(", n_papers, ")"
        #   ),
        color = ifelse(share > 0.25, "white", "black")),
    size = 5
  ) +
  scale_fill_gradient(
    name = "Share of items\nwithin income group ",
    low = "#f7f4f9", high = "#541F78",
    labels = scales::percent,
    oob    = scales::squish,
    limits = c(0.01, 0.99),
  ) +
  scale_color_identity() +
  labs(x = "Income group", y = NULL) +
  theme_minimal(base_size = 19) +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(size = 22),
    axis.text.y = element_text(size = 22),
    axis.title = element_text(size = 22),
    legend.position = "top"
  )

pdf("plots/Figure2_category_survey_by_income_share_noEurob.pdf", width = 12, height = 10)
p4
dev.off()

ggsave(plot = p4 + 
         theme(
           legend.position = "none",
           axis.text.y = element_text(size = 12),
           axis.text.x = element_text(size = 12),
           axis.title = element_text(size = 12)
         ),
       filename = paste("plots/Figure2_category_survey_by_income_share_noEurob.png", sep = ""),
       dpi=600, width = 16, height = 10, units='cm')

```




## per exposure level using shares --- actual panel c and f

```{r exposure level shares}

#-------------------------------------------------------------------------------
# papers
#-------------------------------------------------------------------------------

# 1. Prepare topic-level data (shares within exposure group, based on unique papers)
topics_data_poll <- papers %>%
  filter(!is.na(categoryPollution)) %>%
  distinct(ID, categoryPollution, category) %>%          # each paper counts once per (exposure, category)
  count(categoryPollution, category, name = "n_papers") %>%   # number of papers mentioning category
  rename(Topic = category) %>%
  mutate(
    # if you want a specific topic order, same as income plot:
    Topic = factor(
      Topic,
      levels = rev(c("Perceptions", "Behavior", "Priority", "Policy", "Health"))
    )
  )

# 2. Prepare totals row data (absolute counts of papers per exposure group)
totals_data_poll <- dataSummary %>%
  filter(!is.na(categoryPollution)) %>%
  group_by(categoryPollution) %>%
  summarize(total = sum(n_papers, na.rm = TRUE), .groups = "drop")

# 3. Add shares within exposure group (based on unique papers)
topics_data_poll <- topics_data_poll %>%
  left_join(totals_data_poll, by = "categoryPollution") %>%
  group_by(categoryPollution) %>%
  mutate(
    share = n_papers / total   # share of papers in that exposure group mentioning the topic
  ) %>%
  ungroup()

p5 <- ggplot() +
  # --- top totals row ---
  geom_tile(
    data = totals_data_poll,
    aes(x = categoryPollution, y = "Total papers", fill = total),
    color = "white", linewidth = 0.8
  ) +
  geom_text(
    data = totals_data_poll,
    aes(
      x = categoryPollution,
      y = "Total papers",
      label = paste0("n=", total),
      color = "black"
    ),
    size = 5
  ) +
  scale_fill_gradient(
    name  = "Total papers",
    low   = "#F6DBA7",
    high  = "#F7B32B",
    breaks = range(totals_data_poll$total),
    labels = range(totals_data_poll$total)
  ) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(
    data = topics_data_poll,
    aes(x = categoryPollution, y = Topic, fill = share),
    color = "white", linewidth = 0.8
  ) +
  geom_text(
    data = topics_data_poll,
    aes(
      x = categoryPollution,
      y = Topic,
      # OPTION 1: percentage only (like your current income plot)
      label = scales::percent(share, accuracy = 1),
      # OPTION 2: uncomment this instead for "percent\n(n_papers)"
      # label = paste0(
      #   scales::percent(share, accuracy = 1),
      #   "\n(", n_papers, ")"
      # ),
      color = ifelse(share > 0.25, "white", "black")
    ),
    size = 5
  ) +
  scale_fill_gradient(
    name   = "Share of papers\nwithin exposure group ",
    low    = "#f7f4f9",
    high   = "#8B475D",
    labels = scales::percent,
    breaks = c(min(topics_data_poll$share), max(topics_data_poll$share))
  ) +
  scale_color_identity() +
  labs(x = "Exposure group", y = NULL) +
  theme_minimal(base_size = 19) +
  theme(
    panel.grid   = element_blank(),
    axis.text.x  = element_text(size = 22),
    axis.text.y  = element_text(size = 22),
    axis.title   = element_text(size = 22),
    legend.position = "top"
  )
# 4. Plot with two independent fill scales
pdf("plots/Figure2_category_paper_by_exposure_share.pdf", width = 12, height = 10)
p5
dev.off()

ggsave(plot = p5 + 
         theme(
           legend.position = "none",
           axis.text.y = element_text(size = 12),
           axis.text.x = element_text(size = 12),
           axis.title = element_text(size = 12)
         ),
       filename = paste("plots/Figure2_category_paper_by_exposure_share.png", sep = ""),
       dpi=600, width = 16, height = 10, units='cm')


#-------------------------------------------------------------------------------
# surveys
#-------------------------------------------------------------------------------

# 1. Prepare topic-level data (shares within exposure group, based on unique survey items)
topics_data_survey_poll <- surveys %>%
  filter(!is.na(categoryPollution)) %>%
  mutate(item_id = paste0(iso3, id, year)) %>%                      # unique survey item ID
  distinct(item_id, categoryPollution, category) %>%          # each item counts once per (exposure, topic)
  count(categoryPollution, category, name = "n_items") %>%    # number of items mentioning category
  rename(Topic = category) %>%
  mutate(
    # optional: topic order, same as your income-group plot
    Topic = factor(
      Topic,
      levels = rev(c("Perceptions", "Behavior", "Priority", "Policy", "Health"))
    )
    # optional: control exposure group order, e.g.:
    # categoryPollution = factor(
    #   categoryPollution,
    #   levels = c("Air pollution", "Water pollution", "Other")  # adjust to your data
    # )
  )

# 2. Prepare totals row data (absolute counts of unique items per exposure group)
totals_data_survey_poll <- surveys %>%
  filter(!is.na(categoryPollution)) %>%
  mutate(item_id = paste0(iso3, id, year)) %>%
  group_by(categoryPollution) %>%
  summarise(
    total = n_distinct(item_id),
    .groups = "drop"
  )
  # optional: match factor ordering here too
  # %>%
  # mutate(
  #   categoryPollution = factor(
  #     categoryPollution,
  #     levels = c("Air pollution", "Water pollution", "Other")
  #   )
  # )

# 3. Add shares within exposure group (based on unique items)
topics_data_survey_poll <- topics_data_survey_poll %>%
  left_join(totals_data_survey_poll, by = "categoryPollution") %>%
  group_by(categoryPollution) %>%
  mutate(
    share = n_items / total   # share of survey items in that exposure group mentioning the topic
  ) %>%
  ungroup()

p6 <- ggplot() +
  # --- top totals row ---
  geom_tile(
    data = totals_data_survey_poll,
    aes(x = categoryPollution, y = "Total items", fill = total),
    color = "white", linewidth = 0.8
  ) +
  geom_text(
    data = totals_data_survey_poll,
    aes(
      x = categoryPollution,
      y = "Total items",
      label = paste0("n=", total),
      color = "black"
    ),
    size = 5
  ) +
  scale_fill_gradient(
    name   = "Total items",
    low    = "#F6DBA7",
    high   = "#F7B32B",
    breaks = range(totals_data_survey_poll$total),
    labels = range(totals_data_survey_poll$total)
  ) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(
    data = topics_data_survey_poll,
    aes(x = categoryPollution, y = Topic, fill = share),
    color = "white", linewidth = 0.8
  ) +
  geom_text(
    data = topics_data_survey_poll,
    aes(
      x = categoryPollution,
      y = Topic,
      # OPTION 1: percentage only (mirroring your income-group code)
      label = scales::percent(share, accuracy = 1),
      # OPTION 2: percentage + underlying n_items
      # label = paste0(
      #   scales::percent(share, accuracy = 1),
      #   "\n(", n_items, ")"
      # ),
      color = ifelse(share > 0.25, "white", "black")
    ),
    size = 5
  ) +
  scale_fill_gradient(
    name   = "Share of items\nwithin exposure group ",
    low    = "#f7f4f9",
    high   = "#541F78",
    labels = scales::percent,
    breaks = c(min(topics_data_survey_poll$share), max(topics_data_survey_poll$share))
  ) +
  scale_color_identity() +
  labs(x = "Exposure group", y = NULL) +
  theme_minimal(base_size = 19) +
  theme(
    panel.grid    = element_blank(),
    axis.text.x   = element_text(size = 22),
    axis.text.y   = element_text(size = 22),
    axis.title    = element_text(size = 22),
    legend.position = "top"
  )


# 4. Plot with two independent fill scales
pdf("plots/Figure2_category_item_by_exposure_share.pdf", width = 12, height = 10)
p6
dev.off()

ggsave(plot = p6 + 
         theme(
           legend.position = "none",
           axis.text.y = element_text(size = 12),
           axis.text.x = element_text(size = 12),
           axis.title = element_text(size = 12)
         ),
       filename = paste("plots/Figure2_category_item_by_exposure_share.png", sep = ""),
       dpi=600, width = 16, height = 10, units='cm')

```

## per exposure level using shares, subsetting india china eurobarometer

```{r exposure level shares indchnbaro}

#-------------------------------------------------------------------------------
# papers
#-------------------------------------------------------------------------------

# 1. Prepare topic-level data (shares within exposure group, based on unique papers)
topics_data_poll <- papers %>%
  filter(!is.na(categoryPollution)) %>%
  filter(country %ni% c("China", "India")) %>% 
  distinct(ID, categoryPollution, category) %>%          # each paper counts once per (exposure, category)
  count(categoryPollution, category, name = "n_papers") %>%   # number of papers mentioning category
  rename(Topic = category) %>%
  mutate(
    # if you want a specific topic order, same as income plot:
    Topic = factor(
      Topic,
      levels = rev(c("Perceptions", "Behavior", "Priority", "Policy", "Health"))
    )
  )

# 2. Prepare totals row data (absolute counts of papers per exposure group)
totals_data_poll <- dataSummary %>%
  filter(!is.na(categoryPollution)) %>%
  filter(countryName %ni% c("China", "India")) %>% 
  group_by(categoryPollution) %>%
  summarize(total = sum(n_papers, na.rm = TRUE), .groups = "drop")

# 3. Add shares within exposure group (based on unique papers)
topics_data_poll <- topics_data_poll %>%
  left_join(totals_data_poll, by = "categoryPollution") %>%
  group_by(categoryPollution) %>%
  mutate(
    share = n_papers / total   # share of papers in that exposure group mentioning the topic
  ) %>%
  ungroup()

p5 <- ggplot() +
  # --- top totals row ---
  geom_tile(
    data = totals_data_poll,
    aes(x = categoryPollution, y = "Total papers", fill = total),
    color = "white", linewidth = 0.8
  ) +
  geom_text(
    data = totals_data_poll,
    aes(
      x = categoryPollution,
      y = "Total papers",
      label = paste0("n=", total),
      color = "black"
    ),
    size = 5
  ) +
  scale_fill_gradient(
    name  = "Total papers",
    low   = "#F6DBA7",
    high  = "#F7B32B",
    breaks = range(totals_data_poll$total),
    labels = range(totals_data_poll$total)
  ) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(
    data = topics_data_poll,
    aes(x = categoryPollution, y = Topic, fill = share),
    color = "white", linewidth = 0.8
  ) +
  geom_text(
    data = topics_data_poll,
    aes(
      x = categoryPollution,
      y = Topic,
      # OPTION 1: percentage only (like your current income plot)
      label = scales::percent(share, accuracy = 1),
      # OPTION 2: uncomment this instead for "percent\n(n_papers)"
      # label = paste0(
      #   scales::percent(share, accuracy = 1),
      #   "\n(", n_papers, ")"
      # ),
      color = ifelse(share > 0.25, "white", "black")
    ),
    size = 5
  ) +
  scale_fill_gradient(
    name   = "Share of papers\nwithin exposure group ",
    low    = "#f7f4f9",
    high   = "#8B475D",
    labels = scales::percent,
    breaks = c(min(topics_data_poll$share), max(topics_data_poll$share))
  ) +
  scale_color_identity() +
  labs(x = "Exposure group", y = NULL) +
  theme_minimal(base_size = 19) +
  theme(
    panel.grid   = element_blank(),
    axis.text.x  = element_text(size = 22),
    axis.text.y  = element_text(size = 22),
    axis.title   = element_text(size = 22),
    legend.position = "top"
  )

# 4. Plot with two independent fill scales
pdf("plots/Figure2_category_paper_by_exposure_share_noIndChn.pdf", width = 12, height = 10)
p5
dev.off()

ggsave(plot = p5 + 
         theme(
           legend.position = "none",
           axis.text.y = element_text(size = 12),
           axis.text.x = element_text(size = 12),
           axis.title = element_text(size = 12)
         ),
       filename = paste("plots/Figure2_category_paper_by_exposure_share_noIndChn.png", sep = ""),
       dpi=600, width = 16, height = 10, units='cm')


#-------------------------------------------------------------------------------
# surveys
#-------------------------------------------------------------------------------

# 1. Prepare topic-level data (shares within exposure group, based on unique survey items)
topics_data_survey_poll <- surveys %>%
  filter(!is.na(categoryPollution)) %>%
  mutate(eurobarometerSource = ifelse(grepl("Eurobarometer", source, ignore.case = TRUE) | source == "Flash 123", 1, 0)) %>% 
  filter(eurobarometerSource != 1) %>%
  mutate(item_id = paste0(iso3, id, year)) %>%                      # unique survey item ID
  distinct(item_id, categoryPollution, category) %>%          # each item counts once per (exposure, topic)
  count(categoryPollution, category, name = "n_items") %>%    # number of items mentioning category
  rename(Topic = category) %>%
  mutate(
    # optional: topic order, same as your income-group plot
    Topic = factor(
      Topic,
      levels = rev(c("Perceptions", "Behavior", "Priority", "Policy", "Health"))
    )
    # optional: control exposure group order, e.g.:
    # categoryPollution = factor(
    #   categoryPollution,
    #   levels = c("Air pollution", "Water pollution", "Other")  # adjust to your data
    # )
  )

# 2. Prepare totals row data (absolute counts of unique items per exposure group)
totals_data_survey_poll <- surveys %>%
  filter(!is.na(categoryPollution)) %>%
  mutate(eurobarometerSource = ifelse(grepl("Eurobarometer", source, ignore.case = TRUE) | source == "Flash 123", 1, 0)) %>% 
  filter(eurobarometerSource != 1) %>%
  mutate(item_id = paste0(iso3, id, year)) %>%
  group_by(categoryPollution) %>%
  summarise(
    total = n_distinct(item_id),
    .groups = "drop"
  )
  # optional: match factor ordering here too
  # %>%
  # mutate(
  #   categoryPollution = factor(
  #     categoryPollution,
  #     levels = c("Air pollution", "Water pollution", "Other")
  #   )
  # )

# 3. Add shares within exposure group (based on unique items)
topics_data_survey_poll <- topics_data_survey_poll %>%
  left_join(totals_data_survey_poll, by = "categoryPollution") %>%
  group_by(categoryPollution) %>%
  mutate(
    share = n_items / total   # share of survey items in that exposure group mentioning the topic
  ) %>%
  ungroup()

p6 <- ggplot() +
  # --- top totals row ---
  geom_tile(
    data = totals_data_survey_poll,
    aes(x = categoryPollution, y = "Total items", fill = total),
    color = "white", linewidth = 0.8
  ) +
  geom_text(
    data = totals_data_survey_poll,
    aes(
      x = categoryPollution,
      y = "Total items",
      label = paste0("n=", total),
      color = "black"
    ),
    size = 5
  ) +
  scale_fill_gradient(
    name   = "Total items",
    low    = "#F6DBA7",
    high   = "#F7B32B",
    breaks = range(totals_data_survey_poll$total),
    labels = range(totals_data_survey_poll$total)
  ) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(
    data = topics_data_survey_poll,
    aes(x = categoryPollution, y = Topic, fill = share),
    color = "white", linewidth = 0.8
  ) +
  geom_text(
    data = topics_data_survey_poll,
    aes(
      x = categoryPollution,
      y = Topic,
      # OPTION 1: percentage only (mirroring your income-group code)
      label = scales::percent(share, accuracy = 1),
      # OPTION 2: percentage + underlying n_items
      # label = paste0(
      #   scales::percent(share, accuracy = 1),
      #   "\n(", n_items, ")"
      # ),
      color = ifelse(share > 0.25, "white", "black")
    ),
    size = 5
  ) +
  scale_fill_gradient(
    name   = "Share of items\nwithin exposure group ",
    low    = "#f7f4f9",
    high   = "#541F78",
    labels = scales::percent,
    limits = c(0.01, 0.99),
  ) +
  scale_color_identity() +
  labs(x = "Exposure group", y = NULL) +
  theme_minimal(base_size = 19) +
  theme(
    panel.grid    = element_blank(),
    axis.text.x   = element_text(size = 22),
    axis.text.y   = element_text(size = 22),
    axis.title    = element_text(size = 22),
    legend.position = "top"
  )

# 4. Plot with two independent fill scales
pdf("plots/Figure2_category_item_by_exposure_share_noEurobar.pdf", width = 12, height = 10)
p6
dev.off()

ggsave(plot = p6 + 
         theme(
           legend.position = "none",
           axis.text.y = element_text(size = 12),
           axis.text.x = element_text(size = 12),
           axis.title = element_text(size = 12)
         ),
       filename = paste("plots/Figure2_category_item_by_exposure_share_noEurobar.png", sep = ""),
       dpi=600, width = 16, height = 10, units='cm')

```



#### drafts archive

## Visualizations by income group

```{r income group}

#-------------------------------------------------------------------------------
# papers
#-------------------------------------------------------------------------------

# 1. Prepare topic-level data (shares within income group)
topics_data <- papers %>%
  count(Income.group, category, name = "n") %>%   # counts per category
  rename(Topic = category) %>% 
  filter(!is.na(Income.group)) %>% 
  mutate(Income.group = factor(
    Income.group,
    levels = c("Low income", "Lower middle income", "Upper middle income", "High income"))) %>% 
  group_by(Income.group) %>% 
  mutate(share = n / sum(n))   # sum(n) is the grand total here

# 2. Prepare totals row data (absolute counts)
totals_data <- dataSummary %>%
  filter(!is.na(Income.group)) %>%
  group_by(Income.group) %>% 
  summarize(total = sum(n_papers, na.rm=T))

# 3. Define consistent factor levels for the y-axis
topic_levels <- c("Total papers", unique(topics_data$Topic))

# 4. Plot with two independent fill scales
pdf("plots/Figure2_category_paper_by_income.pdf", width = 10)
ggplot() +
  # --- top totals row ---
  geom_tile(data = totals_data,
            aes(x = Income.group, y = "Total papers", fill = total),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = totals_data,
    aes(x = Income.group, y = "Total papers",
        label = paste0("n=", total),
        color = ifelse(total > max(topics_data$total) * 0.4, "black", "black")), size = 4) +
  scale_fill_gradient(
    name = "Total papers",
    low = "#F6DBA7", high = "#F7B32B",
    breaks = range(totals_data$total),         
  labels = range(totals_data$total)) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(data = topics_data,
            aes(x = Income.group, y = Topic, fill = share),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = topics_data,
    aes(x = Income.group, y = Topic,
        label = scales::percent(share, accuracy = 1),
        color = ifelse(share > 0.25, "white", "black")),
    size = 4) +
  scale_fill_gradient(
    name = "Share within\nincome group",
    low = "#f7f4f9", high = "#8B475D",
    labels = scales::percent,
    breaks = c(min(topics_data$share), max(topics_data$share))) +
  scale_color_identity() +
labs(x = "Income group", y = NULL) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 30, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    legend.position = "top")

dev.off()

#-------------------------------------------------------------------------------
# surveys
#-------------------------------------------------------------------------------

# 1. Prepare topic-level data (shares within income group)
topics_data_s <- surveys %>%
  count(Income.group, category, name = "n") %>%   # counts per category
  rename(Topic = category) %>% 
  filter(!is.na(Income.group)) %>% 
  mutate(Income.group = factor(
    Income.group,
    levels = c("Low income", "Lower middle income", "Upper middle income", "High income"))) %>% 
  group_by(Income.group) %>% 
  mutate(share = n / sum(n))   # sum(n) is the grand total here


# 2. Prepare totals row data (absolute counts)
totals_data_s <- dataSummary %>%
  filter(!is.na(Income.group)) %>%
  group_by(Income.group) %>% 
  summarize(total_items = sum(n_surveys, na.rm=T))


# 3. Define consistent factor levels for the y-axis
topic_levels_s <- c("Total items", unique(topics_data_s$Topic))

# 4. Plot with two independent fill scales
pdf("plots/Figure2_category_survey_by_income.pdf", width = 10)
ggplot() +
  # --- top totals row ---
  geom_tile(data = totals_data_s,
            aes(x = Income.group, y = "Total items", fill = total_items),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = totals_data_s,
    aes(x = Income.group, y = "Total items",
        label = paste0("n=", total_items),
        color = ifelse(total_items > max(totals_data_s$total_items) * 0.4, "black", "black")), size = 4) +
  scale_fill_gradient(
    name = "Total items",
    low = "#F6DBA7", high = "#F7B32B",
    breaks = range(totals_data_s$total_items),         
  labels = range(totals_data_s$total_items)) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(data = topics_data_s,
            aes(x = Income.group, y = Topic, fill = share),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = topics_data_s,
    aes(x = Income.group, y = Topic,
        label = scales::percent(share, accuracy = 1),
        color = ifelse(share > 0.25, "white", "black")),
    size = 4) +
  scale_fill_gradient(
    name = "Share within\nincome group",
    low = "#F3EBF8", high = "#541F78",
    labels = scales::percent,
    breaks = c(min(topics_data_s$share), max(topics_data_s$share))) +
  scale_color_identity() +
labs(x = "Income group", y = NULL) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 30, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    legend.position = "top")

dev.off()

```

## Visualizations full data

```{r visualise}

#-------------------------------------------------------------------------------
# papers
#-------------------------------------------------------------------------------

# count category
papers_long <- papers %>%
  count(category, name = "n") %>%   # counts per category
  mutate(share = n / sum(n)) %>%    # sum(n) is the grand total here
  rename(Topic = category)

# bar plot with counts and percentage labels
pdf("plots/Figure2_category_paper_barplot.pdf")
ggplot(papers_long, aes(x = reorder(Topic, -n), y = n, fill = Topic)) +
  geom_col(color = "black") +
  geom_text(aes(label = percent(share, accuracy = 1)),
            vjust = -0.3, size = 5) +
  labs(x = NULL, y = "Number of papers") +
  scale_fill_manual(values = c(
    "Perceptions" = "#8B7B8B",
    "Behavior"    = "#EED8AE",
    "Priority"    = "#CDB5CD",
    "Policy"      = "#CD919E",
    "Health"      = "#8B475D",
    "None"        = "#F4A460")) +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 30, hjust = 1, size = 15),
    axis.text.y = element_text(size = 15),
    axis.title = element_text(size = 16)
    )
dev.off()


## Different visualisation

pdf("plots/Figure2_category_paper_tiles.pdf")
ggplot(papers_long, aes(area = share, fill = Topic, label = paste0(Topic, "\n", scales::percent(share, accuracy = 1)))) +
  geom_treemap(color = "white", size = 10) +
  geom_treemap_text(colour = "white", place = "centre", grow = F, reflow = TRUE) +
  scale_fill_manual(values = c(
  "Perceptions" = "#8B7B8B",
  "Behavior"    = "#EED8AE",
  "Priority"    = "#CDB5CD",
  "Policy"      = "#CD919E",
  "Health"      = "#8B475D",
  "None"        = "#F4A460")) +
  theme(legend.position = "none")
dev.off()



#-------------------------------------------------------------------------------
# surveys
#-------------------------------------------------------------------------------
surveys_long <- surveys %>%
  count(category, name = "n") %>%   # counts per category
  mutate(share = n / sum(n)) %>%    # sum(n) is the grand total here
  rename(Topic = category)

# bar plot with counts and percentage labels
pdf("plots/Figure2_category_survey_barplot.pdf")
ggplot(surveys_long, aes(x = reorder(Topic, -n), y = n, fill = Topic)) +
  geom_col(color = "black") +
  geom_text(aes(label = percent(share, accuracy = 1)),
            vjust = -0.3, size = 5) +
  labs(x = NULL, y = "Number of items") +
  scale_fill_manual(values = c(
    "Perceptions" = "#8B7B8B",
    "Behavior"    = "#EED8AE",
    "Priority"    = "#CDB5CD",
    "Policy"      = "#CD919E",
    "Health"      = "#8B475D",
    "None"        = "#F4A460")) +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 30, hjust = 1, size = 15),
    axis.text.y = element_text(size = 15),
    axis.title = element_text(size = 16))
dev.off()

## Different approach
pdf("plots/Figure2_category_survey_tiles.pdf")
ggplot(surveys_long, aes(area = share, fill = Topic, label = paste0(Topic, "\n", scales::percent(share, accuracy = 1)))) +
  geom_treemap(color = "white", size = 10) +
  geom_treemap_text(colour = "white", place = "centre", grow = F, reflow = TRUE) +
  scale_fill_manual(values = c(
  "Perceptions" = "#8B7B8B",
  "Behavior"    = "#EED8AE",
  "Priority"    = "#CDB5CD",
  "Policy"      = "#CD919E",
  "Health"      = "#8B475D",
  "None"        = "#F4A460")) +
  theme(legend.position = "none")
dev.off()

```


# Visualizations by income group, with proportional weighting

```{r visualisation income weighting}

#-------------------------------------------------------------------------------
# papers
#-------------------------------------------------------------------------------

## 1. Compute country-weights per paper x income group -----------------------

## Alternative approach: also account for multiple categories per paper -----
paper_country_weights <- papers %>%
  distinct(ID, country, Income.group) %>%
  group_by(ID) %>%
  mutate(n_countries_total = n_distinct(country)) %>%
  group_by(ID, Income.group, n_countries_total) %>%
  summarise(n_countries_group = n_distinct(country), .groups = "drop") %>%
  mutate(country_weight = n_countries_group / n_countries_total) %>%
  dplyr::select(ID, Income.group, country_weight)

papers_pic <- papers %>%
  filter(!is.na(Income.group), !is.na(category)) %>%
  distinct(ID, Income.group, category) %>%
  group_by(ID) %>%
  mutate(n_cat = n_distinct(category)) %>%
  ungroup() %>%
  left_join(paper_country_weights, by = c("ID", "Income.group")) %>%
  mutate(weight = country_weight / n_cat)

topics_data <- papers_pic %>%
  group_by(Income.group, category) %>%
  summarise(weighted_n = sum(weight, na.rm = TRUE), .groups = "drop") %>%
  rename(Topic = category) %>%
  group_by(Income.group) %>%
  mutate(
    share = weighted_n / sum(weighted_n),
    total = sum(weighted_n)
  ) %>%
  ungroup() %>%
  mutate(
    Income.group = factor(
      Income.group,
      levels = c("Low income", "Lower middle income", "Upper middle income", "High income")
    ),
    Topic = factor(
      Topic,
      levels = rev(c("Perceptions", "Behavior", "Priority", "Policy", "Health"))
    )
  )

## 3. Compute weighted category shares within each income group --------------

# topics_data <- papers_weighted %>%
#   filter(!is.na(Income.group), !is.na(category)) %>%
#   group_by(Income.group, category) %>%
#   summarise(
#     weighted_n = sum(country_weight, na.rm = TRUE),
#     .groups = "drop"
#   ) %>%
#   rename(Topic = category) %>%
#   mutate(
#     Income.group = factor(
#       Income.group,
#       levels = c("Low income", "Lower middle income", "Upper middle income", "High income")
#     ),
#     Topic = factor(
#       Topic,
#       levels = rev(c("Perceptions", "Behavior", "Priority", "Policy", "Health"))
#     )
#   ) %>%
#   group_by(Income.group) %>%
#   mutate(
#     share = weighted_n / sum(weighted_n),
#     total = sum(weighted_n)        # weighted total "papers" per income group
#   ) %>%
#   ungroup()

## 4. Data for the top "total papers" row -----------------------------------

totals_data <- topics_data %>%
  group_by(Income.group) %>%
  summarise(total = round(first(total)), .groups = "drop") %>%
  mutate(Topic = "Total papers")   # so it can align in the same plot if needed

## 5. Plot (heatmap) --------------------------------------------------------

pdf("plots/Figure2_category_paper_by_income_weight.pdf", width = 12, height = 10)
ggplot() +
  # --- top totals row ---
  geom_tile(data = totals_data,
            aes(x = Income.group, y = "Total papers", fill = total),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = totals_data,
    aes(x = Income.group, y = "Total papers",
        label = paste0("n=", total),
        color = "black"),
    size = 7
  ) +
  scale_fill_gradient(
    name = "Total papers",
    low = "#F6DBA7", high = "#F7B32B",
    breaks = range(totals_data$total),
    labels = range(totals_data$total)
  ) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(data = topics_data,
            aes(x = Income.group, y = Topic, fill = share),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = topics_data,
    aes(x = Income.group, y = Topic,
        label = scales::percent(share, accuracy = 1),
        # label = paste0(
        #     scales::percent(share, accuracy = 1), 
        #     "\n(", n_papers, ")"
        #   ),
        color = ifelse(share > 0.25, "white", "black")),
    size = 7
  ) +
  scale_fill_gradient(
    name = "Share of papers\nwithin income group ",
    low = "#f7f4f9", high = "#8B475D",
    labels = scales::percent,
    breaks = c(min(topics_data$share), max(topics_data$share))
  ) +
  scale_color_identity() +
  labs(x = "Income group", y = NULL) +
  theme_minimal(base_size = 19) +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 30, hjust = 1, size = 22),
    axis.text.y = element_text(size = 22),
    axis.title = element_text(size = 22),
    legend.position = "top"
  )
dev.off()

```


## Visualizations by exposure group

```{r exposure group}

#-------------------------------------------------------------------------------
# papers
#-------------------------------------------------------------------------------

# 1. Prepare topic-level data (shares within exposure group)
topics_data_poll <- papers %>%
  count(categoryPollution, category, name = "n") %>%   # counts per category
  rename(Topic = category) %>% 
  filter(!is.na(categoryPollution)) %>% 
  group_by(categoryPollution) %>% 
  mutate(share = n / sum(n))   # sum(n) is the grand total here

# 2. Prepare totals row data (absolute counts)
totals_data_poll <- dataSummary %>%
  filter(!is.na(categoryPollution)) %>%
  group_by(categoryPollution) %>% 
  summarize(total = sum(n_papers, na.rm=T))

# 3. Define consistent factor levels for the y-axis
topic_levels <- c("Total papers", unique(topics_data_poll$Topic))

# 4. Plot with two independent fill scales
pdf("plots/Figure2_category_paper_by_exposure.pdf", width = 10)
ggplot() +
  # --- top totals row ---
  geom_tile(data = totals_data_poll,
            aes(x = categoryPollution, y = "Total papers", fill = total),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = totals_data_poll,
    aes(x = categoryPollution, y = "Total papers",
        label = paste0("n=", total),
        color = ifelse(total > max(topics_data_poll$total) * 0.4, "black", "black")), size = 4) +
  scale_fill_gradient(
    name = "Total papers",
    low = "#F6DBA7", high = "#F7B32B",
    breaks = range(totals_data_poll$total),         
  labels = range(totals_data_poll$total)) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(data = topics_data_poll,
            aes(x = categoryPollution, y = Topic, fill = share),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = topics_data_poll,
    aes(x = categoryPollution, y = Topic,
        label = scales::percent(share, accuracy = 1),
        color = ifelse(share > 0.25, "white", "black")),
    size = 4) +
  scale_fill_gradient(
    name = "Share within\nexposure group",
    low = "#f7f4f9", high = "#8B475D",
    labels = scales::percent,
    breaks = c(min(topics_data_poll$share), max(topics_data_poll$share))) +
  scale_color_identity() +
labs(x = "Exposure group", y = NULL) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 30, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    legend.position = "top")

dev.off()

#-------------------------------------------------------------------------------
# surveys
#-------------------------------------------------------------------------------

# 1. Prepare topic-level data (shares within exposure group)
topics_data_poll_s <- surveys %>%
  count(categoryPollution, category, name = "n") %>%   # counts per category
  rename(Topic = category) %>% 
  filter(!is.na(categoryPollution)) %>% 
  group_by(categoryPollution) %>% 
  mutate(share = n / sum(n))   # sum(n) is the grand total here

# 2. Prepare totals row data (absolute counts)
totals_data_poll_s <- dataSummary %>%
  filter(!is.na(categoryPollution)) %>%
  group_by(categoryPollution) %>% 
  summarize(total_items = sum(n_surveys, na.rm=T))

# 3. Define consistent factor levels for the y-axis
topic_levels_s <- c("Total items", unique(topics_data_poll_s$Topic))

# 4. Plot with two independent fill scales
pdf("plots/Figure2_category_survey_by_exposure.pdf", width = 10)
ggplot() +
  # --- top totals row ---
  geom_tile(data = totals_data_poll_s,
            aes(x = categoryPollution, y = "Total items", fill = total_items),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = totals_data_poll_s,
    aes(x = categoryPollution, y = "Total items",
        label = paste0("n=", total_items),
        color = ifelse(total_items > max(totals_data_poll_s$total_items) * 0.4, "black", "black")), size = 4) +
  scale_fill_gradient(
    name = "Total items",
    low = "#F6DBA7", high = "#F7B32B",
    breaks = range(totals_data_poll_s$total_items),         
  labels = range(totals_data_poll_s$total_items)) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(data = topics_data_poll_s,
            aes(x = categoryPollution, y = Topic, fill = share),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = topics_data_poll_s,
    aes(x = categoryPollution, y = Topic,
        label = scales::percent(share, accuracy = 1),
        color = ifelse(share > 0.25, "white", "black")),
    size = 4) +
  scale_fill_gradient(
    name = "Share within\nexposure group",
    low = "#F3EBF8", high = "#541F78",
    labels = scales::percent,
    breaks = c(min(topics_data_poll_s$share), max(topics_data_poll_s$share))) +
  scale_color_identity() +
labs(x = "Exposure group", y = NULL) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 30, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    legend.position = "top")

dev.off()

```

# Visualizations by exposure group, with proportional weighting

```{r visualisation categoryPollution weighting}

#-------------------------------------------------------------------------------
# papers
#-------------------------------------------------------------------------------

## 1. Compute country-weights per paper x categoryPollution -----------------------

# For each paper, how many distinct countries are there in total,
# and how many of those are in each income group?
paper_country_weights <- papers %>%
  distinct(ID, country, categoryPollution) %>%  # ignore category here
  group_by(ID) %>%
  mutate(n_countries_total = n_distinct(country)) %>%
  group_by(ID, categoryPollution, n_countries_total) %>%
  summarise(n_countries_group = n_distinct(country), .groups = "drop") %>%
  mutate(country_weight = n_countries_group / n_countries_total)
# Example: if a paper has 2 countries (1 low, 1 high) then
# country_weight = 0.5 for low income and 0.5 for high income.

## 2. Attach weights back to the (paper x categoryPollution x category) rows ------

papers_weighted <- papers %>%
  left_join(
    paper_country_weights %>%
      dplyr::select(ID, categoryPollution, country_weight),
    by = c("ID", "categoryPollution")
  )

## 3. Compute weighted category shares within each categoryPollution --------------

topics_data <- papers_weighted %>%
  filter(!is.na(categoryPollution), !is.na(category)) %>%
  group_by(categoryPollution, category) %>%
  summarise(
    weighted_n = sum(country_weight, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  rename(Topic = category) %>%
  mutate(
    Topic = factor(
      Topic,
      levels = rev(c("Perceptions", "Behavior", "Priority", "Policy", "Health"))
    )
  ) %>%
  group_by(categoryPollution) %>%
  mutate(
    share = weighted_n / sum(weighted_n),
    total = sum(weighted_n)        # weighted total "papers" per categoryPollution
  ) %>%
  ungroup()

## 4. Data for the top "total papers" row -----------------------------------

totals_data <- topics_data %>%
  group_by(categoryPollution) %>%
  summarise(total = round(first(total)), .groups = "drop") %>%
  mutate(Topic = "Total papers")   # so it can align in the same plot if needed

## 5. Plot (heatmap) --------------------------------------------------------

pdf("plots/Figure2_category_paper_by_exposure_weight.pdf", width = 12, height = 10)
ggplot() +
  # --- top totals row ---
  geom_tile(data = totals_data,
            aes(x = categoryPollution, y = "Total papers", fill = total),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = totals_data,
    aes(x = categoryPollution, y = "Total papers",
        label = paste0("n=", total),
        color = "black"),
    size = 7
  ) +
  scale_fill_gradient(
    name = "Total papers",
    low = "#F6DBA7", high = "#F7B32B",
    breaks = range(totals_data$total),
    labels = range(totals_data$total)
  ) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(data = topics_data,
            aes(x = categoryPollution, y = Topic, fill = share),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = topics_data,
    aes(x = categoryPollution, y = Topic,
        label = scales::percent(share, accuracy = 1),
        # label = paste0(
        #     scales::percent(share, accuracy = 1), 
        #     "\n(", n_papers, ")"
        #   ),
        color = ifelse(share > 0.25, "white", "black")),
    size = 7
  ) +
  scale_fill_gradient(
    name = "Share of papers\nwithin exposure group ",
    low = "#f7f4f9", high = "#8B475D",
    labels = scales::percent,
    breaks = c(min(topics_data$share), max(topics_data$share))
  ) +
  scale_color_identity() +
  labs(x = "Exposure group", y = NULL) +
  theme_minimal(base_size = 19) +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 30, hjust = 1, size = 22),
    axis.text.y = element_text(size = 22),
    axis.title = element_text(size = 22),
    legend.position = "top"
  )
dev.off()

```

