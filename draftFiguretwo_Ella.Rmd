---
title: "Figure two"
author: "Ella Henninger"
date: "2025-10-17"
output: html_document
---

```{r setup, include=FALSE}

## clean environment
rm(list = ls())

# Define which packages needed for analyses
p_needed <-
  c("knitr",
    "dplyr", 
    "stargazer",
    "ggplot2",
    "viridis",
    "haven",
    "MASS",
    "modelsummary",
    "tidyr",
    "data.table",
    "scales",
    "tidyverse",
    "treemapify",
    "ggnewscale")

# Check which packages are already installed on your computer
packages <- rownames(installed.packages())

# Check which packages are not installed
p_to_install <- p_needed[!(p_needed %in% packages)]

if (length(p_to_install) > 0) {
  install.packages(p_to_install)
}
sapply(p_needed, require, character.only = TRUE)


# Set an option for the final document that can be produced from the .Rmd file.
knitr::opts_chunk$set(echo = TRUE)

## For replicability: session information 
session_info <- print(sessionInfo())
```

## Load the data

```{r data}

#-------------------------------------------------------------------------------
# Load the data
#-------------------------------------------------------------------------------
papers <- read.csv2("output/paperClassifYear.csv", 
                    header = T, sep = ",", dec = ".")

surveys <- read.csv2("output/surveyClassifYear.csv", 
                     header = T, sep = ",", dec = ".")

dataSummary <- read.csv("output/datasetPlots.csv")

dataSummary$categoryPollution <- ifelse(
  !is.na(dataSummary$categoryPollution),
  paste0(toupper(substr(dataSummary$categoryPollution, 1, 1)),
         substr(dataSummary$categoryPollution, 2, nchar(dataSummary$categoryPollution))),
  NA
)

dataSummary$categoryPollution <- factor(
  dataSummary$categoryPollution,
  levels = rev(c(
    "Very high",
    "High",
    "Medium",
    "Low",
    "Very low"
  )),
  ordered = TRUE
)

papers <- merge(papers, dataSummary, by = "iso3", all.x = T, all.y = F)
surveys <- merge(surveys, dataSummary, by = "iso3", all.x = T, all.y = F)

```

## Filter (only Inclusion = 1 items)

```{r clean}

#-------------------------------------------------------------------------------
# Inclusion = 1 for survey items 
#-------------------------------------------------------------------------------

## surveys: drop items for which Inclusion == 0
surveys <- surveys[which(surveys$Inclusion == 1),]

## subset survey without Flashbarometer
surveys_sub <- surveys[which(surveys$source != "Flash Eurobarometer 360: Attitudes of Europeans towards air quality"),]

```

## Visualizations full data

```{r visualise}

#-------------------------------------------------------------------------------
# papers
#-------------------------------------------------------------------------------

# count category
papers_long <- papers %>%
  count(category, name = "n") %>%   # counts per category
  mutate(share = n / sum(n)) %>%    # sum(n) is the grand total here
  rename(Topic = category)

# bar plot with counts and percentage labels
pdf("plots/Figure2_category_paper_barplot.pdf")
ggplot(papers_long, aes(x = reorder(Topic, -n), y = n, fill = Topic)) +
  geom_col(color = "black") +
  geom_text(aes(label = percent(share, accuracy = 1)),
            vjust = -0.3, size = 5) +
  labs(x = NULL, y = "Number of papers") +
  scale_fill_manual(values = c(
    "Perceptions" = "#8B7B8B",
    "Behavior"    = "#EED8AE",
    "Priority"    = "#CDB5CD",
    "Policy"      = "#CD919E",
    "Health"      = "#8B475D",
    "None"        = "#F4A460")) +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 30, hjust = 1, size = 15),
    axis.text.y = element_text(size = 15),
    axis.title = element_text(size = 16))
dev.off()


## Different visualisation

pdf("plots/Figure2_category_paper_tiles.pdf")
ggplot(papers_long, aes(area = share, fill = Topic, label = paste0(Topic, "\n", scales::percent(share, accuracy = 1)))) +
  geom_treemap(color = "white", size = 10) +
  geom_treemap_text(colour = "white", place = "centre", grow = F, reflow = TRUE) +
  scale_fill_manual(values = c(
  "Perceptions" = "#8B7B8B",
  "Behavior"    = "#EED8AE",
  "Priority"    = "#CDB5CD",
  "Policy"      = "#CD919E",
  "Health"      = "#8B475D",
  "None"        = "#F4A460")) +
  theme(legend.position = "none")
dev.off()



#-------------------------------------------------------------------------------
# surveys
#-------------------------------------------------------------------------------
surveys_long <- surveys %>%
  count(category, name = "n") %>%   # counts per category
  mutate(share = n / sum(n)) %>%    # sum(n) is the grand total here
  rename(Topic = category)

# bar plot with counts and percentage labels
pdf("plots/Figure2_category_survey_barplot.pdf")
ggplot(surveys_long, aes(x = reorder(Topic, -n), y = n, fill = Topic)) +
  geom_col(color = "black") +
  geom_text(aes(label = percent(share, accuracy = 1)),
            vjust = -0.3, size = 5) +
  labs(x = NULL, y = "Number of items") +
  scale_fill_manual(values = c(
    "Perceptions" = "#8B7B8B",
    "Behavior"    = "#EED8AE",
    "Priority"    = "#CDB5CD",
    "Policy"      = "#CD919E",
    "Health"      = "#8B475D",
    "None"        = "#F4A460")) +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 30, hjust = 1, size = 15),
    axis.text.y = element_text(size = 15),
    axis.title = element_text(size = 16))
dev.off()

## Different approach
pdf("plots/Figure2_category_survey_tiles.pdf")
ggplot(surveys_long, aes(area = share, fill = Topic, label = paste0(Topic, "\n", scales::percent(share, accuracy = 1)))) +
  geom_treemap(color = "white", size = 10) +
  geom_treemap_text(colour = "white", place = "centre", grow = F, reflow = TRUE) +
  scale_fill_manual(values = c(
  "Perceptions" = "#8B7B8B",
  "Behavior"    = "#EED8AE",
  "Priority"    = "#CDB5CD",
  "Policy"      = "#CD919E",
  "Health"      = "#8B475D",
  "None"        = "#F4A460")) +
  theme(legend.position = "none")
dev.off()

```


## Visualizations by income group

```{r income group}

#-------------------------------------------------------------------------------
# papers
#-------------------------------------------------------------------------------

# 1. Prepare topic-level data (shares within income group)
topics_data <- papers %>%
  count(Income.group, category, name = "n") %>%   # counts per category
  rename(Topic = category) %>% 
  filter(!is.na(Income.group)) %>% 
  mutate(Income.group = factor(
    Income.group,
    levels = c("Low income", "Lower middle income", "Upper middle income", "High income"))) %>% 
  group_by(Income.group) %>% 
  mutate(share = n / sum(n))   # sum(n) is the grand total here

# 2. Prepare totals row data (absolute counts)
totals_data <- dataSummary %>%
  filter(!is.na(Income.group)) %>%
  group_by(Income.group) %>% 
  summarize(total = sum(n_papers, na.rm=T))

# 3. Define consistent factor levels for the y-axis
topic_levels <- c("Total papers", unique(topics_data$Topic))

# 4. Plot with two independent fill scales
pdf("plots/Figure2_category_paper_by_income.pdf", width = 10)
ggplot() +
  # --- top totals row ---
  geom_tile(data = totals_data,
            aes(x = Income.group, y = "Total papers", fill = total),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = totals_data,
    aes(x = Income.group, y = "Total papers",
        label = paste0("n=", total),
        color = ifelse(total > max(topics_data$total) * 0.4, "black", "black")), size = 4) +
  scale_fill_gradient(
    name = "Total papers",
    low = "#F6DBA7", high = "#F7B32B",
    breaks = range(totals_data$total),         
  labels = range(totals_data$total)) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(data = topics_data,
            aes(x = Income.group, y = Topic, fill = share),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = topics_data,
    aes(x = Income.group, y = Topic,
        label = scales::percent(share, accuracy = 1),
        color = ifelse(share > 0.25, "white", "black")),
    size = 4) +
  scale_fill_gradient(
    name = "Share within\nincome group",
    low = "#f7f4f9", high = "#8B475D",
    labels = scales::percent,
    breaks = c(min(topics_data$share), max(topics_data$share))) +
  scale_color_identity() +
labs(x = "Income group", y = NULL) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 30, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    legend.position = "top")

dev.off()

#-------------------------------------------------------------------------------
# surveys
#-------------------------------------------------------------------------------

# 1. Prepare topic-level data (shares within income group)
topics_data_s <- surveys %>%
  count(Income.group, category, name = "n") %>%   # counts per category
  rename(Topic = category) %>% 
  filter(!is.na(Income.group)) %>% 
  mutate(Income.group = factor(
    Income.group,
    levels = c("Low income", "Lower middle income", "Upper middle income", "High income"))) %>% 
  group_by(Income.group) %>% 
  mutate(share = n / sum(n))   # sum(n) is the grand total here


# 2. Prepare totals row data (absolute counts)
totals_data_s <- dataSummary %>%
  filter(!is.na(Income.group)) %>%
  group_by(Income.group) %>% 
  summarize(total_items = sum(n_surveys, na.rm=T))


# 3. Define consistent factor levels for the y-axis
topic_levels_s <- c("Total items", unique(topics_data_s$Topic))

# 4. Plot with two independent fill scales
pdf("plots/Figure2_category_survey_by_income.pdf", width = 10)
ggplot() +
  # --- top totals row ---
  geom_tile(data = totals_data_s,
            aes(x = Income.group, y = "Total items", fill = total_items),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = totals_data_s,
    aes(x = Income.group, y = "Total items",
        label = paste0("n=", total_items),
        color = ifelse(total_items > max(totals_data_s$total_items) * 0.4, "black", "black")), size = 4) +
  scale_fill_gradient(
    name = "Total items",
    low = "#F6DBA7", high = "#F7B32B",
    breaks = range(totals_data_s$total_items),         
  labels = range(totals_data_s$total_items)) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(data = topics_data_s,
            aes(x = Income.group, y = Topic, fill = share),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = topics_data_s,
    aes(x = Income.group, y = Topic,
        label = scales::percent(share, accuracy = 1),
        color = ifelse(share > 0.25, "white", "black")),
    size = 4) +
  scale_fill_gradient(
    name = "Share within\nincome group",
    low = "#F3EBF8", high = "#541F78",
    labels = scales::percent,
    breaks = c(min(topics_data_s$share), max(topics_data_s$share))) +
  scale_color_identity() +
labs(x = "Income group", y = NULL) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 30, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    legend.position = "top")

dev.off()

```


## Visualizations by exposure group

```{r exposure group}

#-------------------------------------------------------------------------------
# papers
#-------------------------------------------------------------------------------

# 1. Prepare topic-level data (shares within exposure group)
topics_data_poll <- papers %>%
  count(categoryPollution, category, name = "n") %>%   # counts per category
  rename(Topic = category) %>% 
  filter(!is.na(categoryPollution)) %>% 
  group_by(categoryPollution) %>% 
  mutate(share = n / sum(n))   # sum(n) is the grand total here

# 2. Prepare totals row data (absolute counts)
totals_data_poll <- dataSummary %>%
  filter(!is.na(categoryPollution)) %>%
  group_by(categoryPollution) %>% 
  summarize(total = sum(n_papers, na.rm=T))

# 3. Define consistent factor levels for the y-axis
topic_levels <- c("Total papers", unique(topics_data_poll$Topic))

# 4. Plot with two independent fill scales
pdf("plots/Figure2_category_paper_by_exposure.pdf", width = 10)
ggplot() +
  # --- top totals row ---
  geom_tile(data = totals_data_poll,
            aes(x = categoryPollution, y = "Total papers", fill = total),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = totals_data_poll,
    aes(x = categoryPollution, y = "Total papers",
        label = paste0("n=", total),
        color = ifelse(total > max(topics_data_poll$total) * 0.4, "black", "black")), size = 4) +
  scale_fill_gradient(
    name = "Total papers",
    low = "#F6DBA7", high = "#F7B32B",
    breaks = range(totals_data_poll$total),         
  labels = range(totals_data_poll$total)) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(data = topics_data_poll,
            aes(x = categoryPollution, y = Topic, fill = share),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = topics_data_poll,
    aes(x = categoryPollution, y = Topic,
        label = scales::percent(share, accuracy = 1),
        color = ifelse(share > 0.25, "white", "black")),
    size = 4) +
  scale_fill_gradient(
    name = "Share within\nexposure group",
    low = "#f7f4f9", high = "#8B475D",
    labels = scales::percent,
    breaks = c(min(topics_data_poll$share), max(topics_data_poll$share))) +
  scale_color_identity() +
labs(x = "Exposure group", y = NULL) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 30, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    legend.position = "top")

dev.off()

#-------------------------------------------------------------------------------
# surveys
#-------------------------------------------------------------------------------

# 1. Prepare topic-level data (shares within exposure group)
topics_data_poll_s <- surveys %>%
  count(categoryPollution, category, name = "n") %>%   # counts per category
  rename(Topic = category) %>% 
  filter(!is.na(categoryPollution)) %>% 
  group_by(categoryPollution) %>% 
  mutate(share = n / sum(n))   # sum(n) is the grand total here

# 2. Prepare totals row data (absolute counts)
totals_data_poll_s <- dataSummary %>%
  filter(!is.na(categoryPollution)) %>%
  group_by(categoryPollution) %>% 
  summarize(total_items = sum(n_surveys, na.rm=T))

# 3. Define consistent factor levels for the y-axis
topic_levels_s <- c("Total items", unique(topics_data_poll_s$Topic))

# 4. Plot with two independent fill scales
pdf("plots/Figure2_category_survey_by_exposure.pdf", width = 10)
ggplot() +
  # --- top totals row ---
  geom_tile(data = totals_data_poll_s,
            aes(x = categoryPollution, y = "Total items", fill = total_items),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = totals_data_poll_s,
    aes(x = categoryPollution, y = "Total items",
        label = paste0("n=", total_items),
        color = ifelse(total_items > max(totals_data_poll_s$total_items) * 0.4, "black", "black")), size = 4) +
  scale_fill_gradient(
    name = "Total items",
    low = "#F6DBA7", high = "#F7B32B",
    breaks = range(totals_data_poll_s$total_items),         
  labels = range(totals_data_poll_s$total_items)) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(data = topics_data_poll_s,
            aes(x = categoryPollution, y = Topic, fill = share),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = topics_data_poll_s,
    aes(x = categoryPollution, y = Topic,
        label = scales::percent(share, accuracy = 1),
        color = ifelse(share > 0.25, "white", "black")),
    size = 4) +
  scale_fill_gradient(
    name = "Share within\nexposure group",
    low = "#F3EBF8", high = "#541F78",
    labels = scales::percent,
    breaks = c(min(topics_data_poll_s$share), max(topics_data_poll_s$share))) +
  scale_color_identity() +
labs(x = "Exposure group", y = NULL) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 30, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    legend.position = "top")

dev.off()

```
