---
title: "Figure two"
author: "Ella Henninger"
date: "2025-10-17"
output: html_document
---

```{r setup, include=FALSE}

## clean environment
rm(list = ls())

# Define which packages needed for analyses
p_needed <-
  c("knitr",
    "dplyr", 
    "stargazer",
    "ggplot2",
    "viridis",
    "haven",
    "MASS",
    "modelsummary",
    "tidyr",
    "data.table",
    "scales")

# Check which packages are already installed on your computer
packages <- rownames(installed.packages())

# Check which packages are not installed
p_to_install <- p_needed[!(p_needed %in% packages)]

if (length(p_to_install) > 0) {
  install.packages(p_to_install)
}
sapply(p_needed, require, character.only = TRUE)


# Set an option for the final document that can be produced from the .Rmd file.
knitr::opts_chunk$set(echo = TRUE)

## For replicability: session information 
session_info <- print(sessionInfo())
```

## Load the data

```{r data}

#-------------------------------------------------------------------------------
# Load the data
#-------------------------------------------------------------------------------
papers <- read.csv2("dataNew/data_fig2_papers.csv", 
                    header = T, sep = ",", dec = ".")

surveys <- read.csv2("dataNew/data_fig2_surveys.csv", 
                     header = T, sep = ",", dec = ".")

```

## Clean the data

```{r clean}

#-------------------------------------------------------------------------------
# consistent country names 
#-------------------------------------------------------------------------------

## paper
papers <- papers %>%
  mutate(country_clean = recode(country,
    # Turkey variants
    "Turkey" = "Turkyie",
    "Türkiye" = "Turkyie",
    
    # UK variants
    "UK" = "United Kingdom",
    "England" = "United Kingdom",
    "Wales" = "United Kingdom",
    
    # Korea variants
    "Korea" = "South Korea",
    
    # Netherlands variants
    "The Netherlands" = "Netherlands",
    
    # Czechia variants
    "Czech Republic" = "Czechia",
    
    # US variants
    "USA" = "United States",
    
    .default = country  # keep as is otherwise
  ))

papers <- papers[which(papers$country_clean != "exclude"),]
papers <- papers[which(papers$country_clean != "no info"),]


## survey
surveys <- surveys %>%
  mutate(country_clean = recode(countries,
    # Turkey variants
    "Turkey" = "Turkyie",
    "Türkiye" = "Turkyie",
    
    # UK variants
    "UK" = "United Kingdom",
    "England" = "United Kingdom",
    "Wales" = "United Kingdom",
    
    # Korea variants
    "Korea" = "South Korea",
    
    # Netherlands variants
    "The Netherlands" = "Netherlands",
    
    # Czechia variants
    "Czech Republic" = "Czechia",
    
    # US variants
    "USA" = "United States",
    
    .default = countries  # keep as is otherwise
  ))


#-------------------------------------------------------------------------------
# relevant columns
#-------------------------------------------------------------------------------
papers <- papers[,c("ID", "country_clean",
                    "Income.group", "Region.x", 
                    "Perceptions", "Behavior", "Priority", "Policy", "Health", "None", "pm25Avg")]

surveys <- surveys[,c("id", "country_clean", "year", "Income.group", "Region.x", 
                      "Perceptions", "Behavior", "Priority", "Policy", "Health", "Inclusion", "pm25Avg")]

## surveys: drop items for which Inclusion == 0
surveys <- surveys[which(surveys$Inclusion == 1),]


## subset survey without Flashbarometer
surveys_sub <- surveys[which(surveys$source != "Flash Eurobarometer 360: Attitudes of Europeans towards air quality"),]

```

## Visualizations full data

```{r visualise}

#-------------------------------------------------------------------------------
# papers
#-------------------------------------------------------------------------------

# reshape to long format and count topics
papers_long <- papers %>%
  pivot_longer(
    cols = c(Perceptions, Behavior, Priority, Policy, Health, None),
    names_to = "Topic",
    values_to = "Value"
  ) %>%
  filter(Value == 1) %>%
  group_by(Topic) %>%
  summarise(n = n()) %>%
  mutate(share = n / sum(n))

# bar plot with counts and percentage labels
pdf("plots/Figure2_category_paper_barplot.pdf")
ggplot(papers_long, aes(x = reorder(Topic, -n), y = n, fill = Topic)) +
  geom_col(color = "black") +
  geom_text(aes(label = percent(share, accuracy = 1)),
            vjust = -0.3, size = 5) +
  labs(x = NULL, y = "Number of papers") +
  scale_fill_manual(values = c(
    "Perceptions" = "#8B7B8B",
    "Behavior"    = "#EED8AE",
    "Priority"    = "#CDB5CD",
    "Policy"      = "#CD919E",
    "Health"      = "#8B475D",
    "None"        = "#F4A460")) +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 30, hjust = 1, size = 15),
    axis.text.y = element_text(size = 15),
    axis.title = element_text(size = 16))
dev.off()


## Different visualisation
install.packages("treemapify")
library(treemapify)

pdf("plots/Figure2_category_paper_tiles.pdf")
ggplot(papers_long, aes(area = share, fill = Topic, label = paste0(Topic, "\n", scales::percent(share, accuracy = 1)))) +
  geom_treemap(color = "white", size = 10) +
  geom_treemap_text(colour = "white", place = "centre", grow = F, reflow = TRUE) +
  scale_fill_manual(values = c(
  "Perceptions" = "#8B7B8B",
  "Behavior"    = "#EED8AE",
  "Priority"    = "#CDB5CD",
  "Policy"      = "#CD919E",
  "Health"      = "#8B475D",
  "None"        = "#F4A460")) +
  theme(legend.position = "none")
dev.off()



#-------------------------------------------------------------------------------
# surveys
#-------------------------------------------------------------------------------

# reshape to long format and count topics
surveys_long <- surveys %>%
  pivot_longer(
    cols = c(Perceptions, Behavior, Priority, Policy, Health),
    names_to = "Topic",
    values_to = "Value"
  ) %>%
  filter(Value == 1) %>%
  group_by(Topic) %>%
  summarise(n = n()) %>%
  mutate(share = n / sum(n))

# bar plot with counts and percentage labels
pdf("plots/Figure2_category_survey_barplot.pdf")
ggplot(surveys_long, aes(x = reorder(Topic, -n), y = n, fill = Topic)) +
  geom_col(color = "black") +
  geom_text(aes(label = percent(share, accuracy = 1)),
            vjust = -0.3, size = 5) +
  labs(x = NULL, y = "Number of items") +
  scale_fill_manual(values = c(
    "Perceptions" = "#8B7B8B",
    "Behavior"    = "#EED8AE",
    "Priority"    = "#CDB5CD",
    "Policy"      = "#CD919E",
    "Health"      = "#8B475D",
    "None"        = "#F4A460")) +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 30, hjust = 1, size = 15),
    axis.text.y = element_text(size = 15),
    axis.title = element_text(size = 16))
dev.off()

## Different approach
pdf("plots/Figure2_category_survey_tiles.pdf")
ggplot(surveys_long, aes(area = share, fill = Topic, label = paste0(Topic, "\n", scales::percent(share, accuracy = 1)))) +
  geom_treemap(color = "white", size = 10) +
  geom_treemap_text(colour = "white", place = "centre", grow = F, reflow = TRUE) +
  scale_fill_manual(values = c(
  "Perceptions" = "#8B7B8B",
  "Behavior"    = "#EED8AE",
  "Priority"    = "#CDB5CD",
  "Policy"      = "#CD919E",
  "Health"      = "#8B475D",
  "None"        = "#F4A460")) +
  theme(legend.position = "none")
dev.off()

```


## Visualizations by income group

```{r income group}

#-------------------------------------------------------------------------------
# papers
#-------------------------------------------------------------------------------

install.packages("ggnewscale")
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggnewscale)

# 1. Prepare topic-level data (shares within income group)
topics_data <- papers %>%
  pivot_longer(
    cols = c(Perceptions, Behavior, Priority, Policy, Health, None),
    names_to = "Topic",
    values_to = "Value") %>%
  filter(Value == 1, !is.na(Income.group)) %>%
  group_by(Topic, Income.group) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(Income.group) %>%
  mutate(share = n / sum(n)) %>%
  ungroup() %>%
  mutate(Income.group = factor(
    Income.group,
    levels = c("Low income", "Lower middle income", "Upper middle income", "High income")))

# 2. Prepare totals row data (absolute counts)
totals_data <- papers %>%
  filter(!is.na(Income.group)) %>%
  count(Income.group, name = "total")

# 3. Define consistent factor levels for the y-axis
topic_levels <- c("Total papers", unique(topics_data$Topic))

# 4. Plot with two independent fill scales
pdf("plots/Figure2_category_paper_by_income.pdf", width = 10)
ggplot() +
  # --- top totals row ---
  geom_tile(data = totals_data,
            aes(x = Income.group, y = "Total papers", fill = total),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = totals_data,
    aes(x = Income.group, y = "Total papers",
        label = paste0("n=", total),
        color = ifelse(total > max(topics_data$total) * 0.4, "black", "black")), size = 4) +
  scale_fill_gradient(
    name = "Total papers",
    low = "#F6DBA7", high = "#F7B32B",
    breaks = range(totals_data$total),         
  labels = range(totals_data$total)) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(data = topics_data,
            aes(x = Income.group, y = Topic, fill = share),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = topics_data,
    aes(x = Income.group, y = Topic,
        label = scales::percent(share, accuracy = 1),
        color = ifelse(share > 0.25, "white", "black")),
    size = 4) +
  scale_fill_gradient(
    name = "Share within\nincome group",
    low = "#f7f4f9", high = "#8B475D",
    labels = scales::percent,
    breaks = c(min(topics_data$share), max(topics_data$share))) +
  scale_color_identity() +
labs(x = "Income group", y = NULL) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 30, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    legend.position = "top")

dev.off()

#-------------------------------------------------------------------------------
# surveys
#-------------------------------------------------------------------------------

# 1. Prepare topic-level data (shares within income group)
topics_data_s <- surveys %>%
  pivot_longer(
    cols = c(Perceptions, Behavior, Priority, Policy, Health),
    names_to = "Topic",
    values_to = "Value") %>%
  filter(Value == 1, !is.na(Income.group)) %>%
  group_by(Topic, Income.group) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(Income.group) %>%
  mutate(share = n / sum(n)) %>%
  ungroup() %>%
  mutate(Income.group = factor(
    Income.group,
    levels = c("Low income", "Lower middle income", "Upper middle income", "High income")))

# 2. Prepare totals row data (absolute counts)
totals_data_s <- surveys %>%
  filter(!is.na(Income.group)) %>%
  count(Income.group, name = "total_items")

# 3. Define consistent factor levels for the y-axis
topic_levels_s <- c("Total items", unique(topics_data_s$Topic))

# 4. Plot with two independent fill scales
pdf("plots/Figure2_category_survey_by_income.pdf", width = 10)
ggplot() +
  # --- top totals row ---
  geom_tile(data = totals_data_s,
            aes(x = Income.group, y = "Total items", fill = total_items),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = totals_data_s,
    aes(x = Income.group, y = "Total items",
        label = paste0("n=", total_items),
        color = ifelse(total_items > max(totals_data_s$total_items) * 0.4, "black", "black")), size = 4) +
  scale_fill_gradient(
    name = "Total items",
    low = "#F6DBA7", high = "#F7B32B",
    breaks = range(totals_data_s$total_items),         
  labels = range(totals_data_s$total_items)) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(data = topics_data_s,
            aes(x = Income.group, y = Topic, fill = share),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = topics_data_s,
    aes(x = Income.group, y = Topic,
        label = scales::percent(share, accuracy = 1),
        color = ifelse(share > 0.25, "white", "black")),
    size = 4) +
  scale_fill_gradient(
    name = "Share within\nincome group",
    low = "#F3EBF8", high = "#541F78",
    labels = scales::percent,
    breaks = c(min(topics_data_s$share), max(topics_data_s$share))) +
  scale_color_identity() +
labs(x = "Income group", y = NULL) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 30, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    legend.position = "top")

dev.off()

#"#F3EBF8", "#D4ABEF", "#541F78"

```


## Visualizations by exposure group

```{r exposure group}

#-------------------------------------------------------------------------------
# get exposure groups for papers and surveys
#-------------------------------------------------------------------------------
papers$categoryPollution <- cut(papers$pm25Avg, breaks = c(0, 10, 15, 25, 35, 100), 
                                labels = c("Very low", "Low", "Medium", "High", "Very high"), 
                                right = FALSE)

surveys$categoryPollution <- cut(surveys$pm25Avg, breaks = c(0, 10, 15, 25, 35, 100), 
                                labels = c("Very low", "Low", "Medium", "High", "Very high"), 
                                right = FALSE)


#-------------------------------------------------------------------------------
# papers
#-------------------------------------------------------------------------------

# 1. Prepare topic-level data (shares within exposure group)
topics_data_poll <- papers %>%
  pivot_longer(
    cols = c(Perceptions, Behavior, Priority, Policy, Health, None),
    names_to = "Topic",
    values_to = "Value") %>%
  filter(Value == 1, !is.na(categoryPollution)) %>%
  group_by(Topic, categoryPollution) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(categoryPollution) %>%
  mutate(share = n / sum(n)) %>%
  ungroup() %>%
  mutate(categoryPollution = factor(
    categoryPollution,
    levels = c("Very low", "Low", "Medium", "High", "Very high")))

# 2. Prepare totals row data (absolute counts)
totals_data_poll <- papers %>%
  filter(!is.na(categoryPollution)) %>%
  count(categoryPollution, name = "total")

# 3. Define consistent factor levels for the y-axis
topic_levels <- c("Total papers", unique(topics_data$Topic))

# 4. Plot with two independent fill scales
pdf("plots/Figure2_category_paper_by_exposure.pdf", width = 10)
ggplot() +
  # --- top totals row ---
  geom_tile(data = totals_data_poll,
            aes(x = categoryPollution, y = "Total papers", fill = total),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = totals_data_poll,
    aes(x = categoryPollution, y = "Total papers",
        label = paste0("n=", total),
        color = ifelse(total > max(topics_data_poll$total) * 0.4, "black", "black")), size = 4) +
  scale_fill_gradient(
    name = "Total papers",
    low = "#F6DBA7", high = "#F7B32B",
    breaks = range(totals_data_poll$total),         
  labels = range(totals_data_poll$total)) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(data = topics_data_poll,
            aes(x = categoryPollution, y = Topic, fill = share),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = topics_data_poll,
    aes(x = categoryPollution, y = Topic,
        label = scales::percent(share, accuracy = 1),
        color = ifelse(share > 0.25, "white", "black")),
    size = 4) +
  scale_fill_gradient(
    name = "Share within\nexposure group",
    low = "#f7f4f9", high = "#8B475D",
    labels = scales::percent,
    breaks = c(min(topics_data_poll$share), max(topics_data_poll$share))) +
  scale_color_identity() +
labs(x = "Exposure group", y = NULL) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 30, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    legend.position = "top")

dev.off()

#-------------------------------------------------------------------------------
# surveys
#-------------------------------------------------------------------------------

# 1. Prepare topic-level data (shares within exposure group)
topics_data_poll_s <- surveys %>%
  pivot_longer(
    cols = c(Perceptions, Behavior, Priority, Policy, Health),
    names_to = "Topic",
    values_to = "Value") %>%
  filter(Value == 1, !is.na(categoryPollution)) %>%
  group_by(Topic, categoryPollution) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(categoryPollution) %>%
  mutate(share = n / sum(n)) %>%
  ungroup() %>%
  mutate(categoryPollution = factor(
    categoryPollution,
    levels = c("Very low", "Low", "Medium", "High", "Very high")))

# 2. Prepare totals row data (absolute counts)
totals_data_poll_s <- surveys %>%
  filter(!is.na(categoryPollution)) %>%
  count(categoryPollution, name = "total_items")

# 3. Define consistent factor levels for the y-axis
topic_levels_s <- c("Total items", unique(topics_data_s$Topic))

# 4. Plot with two independent fill scales
pdf("plots/Figure2_category_survey_by_exposure.pdf", width = 10)
ggplot() +
  # --- top totals row ---
  geom_tile(data = totals_data_poll_s,
            aes(x = categoryPollution, y = "Total items", fill = total_items),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = totals_data_poll_s,
    aes(x = categoryPollution, y = "Total items",
        label = paste0("n=", total_items),
        color = ifelse(total_items > max(totals_data_poll_s$total_items) * 0.4, "black", "black")), size = 4) +
  scale_fill_gradient(
    name = "Total items",
    low = "#F6DBA7", high = "#F7B32B",
    breaks = range(totals_data_poll_s$total_items),         
  labels = range(totals_data_poll_s$total_items)) +
  scale_color_identity() +

  ggnewscale::new_scale_fill() +  # reset fill scale

  # --- main topic rows ---
  geom_tile(data = topics_data_poll_s,
            aes(x = categoryPollution, y = Topic, fill = share),
            color = "white", linewidth = 0.8) +
  geom_text(
    data = topics_data_poll_s,
    aes(x = categoryPollution, y = Topic,
        label = scales::percent(share, accuracy = 1),
        color = ifelse(share > 0.25, "white", "black")),
    size = 4) +
  scale_fill_gradient(
    name = "Share within\nexposure group",
    low = "#f7f4f9", high = "#8B475D",
    labels = scales::percent,
    breaks = c(min(topics_data_poll_s$share), max(topics_data_poll_s$share))) +
  scale_color_identity() +
labs(x = "Exposure group", y = NULL) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 30, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    legend.position = "top")

dev.off()

```
